<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Vault (Plain)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d81b60;
      --danger:#ff4d4d;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 30px; }
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding:10px 10px 14px;
    }
    h1{ margin:0; font-size:18px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:12px; }
    .pill{
      padding:8px 12px; border-radius:999px;

    }
    .toolsMenu{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      display:none;
      min-width: 190px;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(20,22,30,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      z-index: 2200;
    }
    .toolsMenu.open{ display:grid; gap:8px; }
    .toolsMenu .btn{
      width:100%;
      justify-content:flex-start;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
      align-items:start;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .hd{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd h2{ margin:0; font-size:14px; }
    .bd{ padding:14px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, textarea{
      width:100%;
      padding:12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus{
      border-color: rgba(216,27,96,.55);
      box-shadow: 0 0 0 3px rgba(216,27,96,.16);
    }

    textarea{
      min-height: 92px;
      resize: vertical;
      line-height: 1.35;
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .grow{ flex:1; }
    .btn{
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{ background: rgba(216,27,96,.85); border-color: rgba(216,27,96,.55); }
    .btn.ghost{ background: rgba(255,255,255,.05); }
    .btn.danger{ background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.30); }
    .btn.small{ padding:9px 10px; font-size:12px; border-radius: 11px; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .list{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    /* Force a true 4-column feel on wide screens */
    @media (min-width: 960px){
      .list{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){ .list{ grid-template-columns: 1fr; } }

    .azBar{
      position: sticky;
      top: 6px;
      z-index: 120;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 8px;
      margin: 0 0 10px;
      background: rgba(11,13,18,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      backdrop-filter: blur(8px);
    }
    .azBtn{
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      cursor: pointer;
      line-height: 26px;
      user-select: none;
      transition: background .15s ease, border-color .15s ease, transform .12s ease;
    }
    .azBtn:hover{ background: rgba(255,255,255,.10); }
    .azBtn.active{
      background: rgba(216,27,96,.85);
      border-color: rgba(216,27,96,.55);
    }
    .azBtn:active{ transform: scale(.96); }
    .azBtn.tapPulse{ animation: azPop .22s ease; }
    @keyframes azPop{ 0%{transform:scale(1);} 55%{transform:scale(1.08);} 100%{transform:scale(1);} }
    .azBtn.disabled{
      opacity: .30;
      pointer-events: none;
    }

    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding:8px 10px;
      cursor:pointer;
      display:grid;
      grid-template-columns: 48px 1fr;
      gap:10px;
      align-items:center;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }

    .azHeader{
      grid-column: 1 / -1;
      padding:6px 10px;
      margin-top:4px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      font-weight:900;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size:12px;
      opacity:.85;
    }
    .item:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.22);
      transform: translateY(-1px);
    }
    .item:active{
      transform: translateY(0px) scale(.995);
    }
    .title{ font-weight:900; margin:0 0 2px; font-size:13px; letter-spacing:.2px; }
    .meta{ color:var(--muted); font-size:12px; line-height:1.25; }
    .meta b{ color:rgba(255,255,255,.82); font-weight:800; }

    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .itemTop .title{ margin:0; }
    .removeFromCollectionBtn{ flex:0 0 auto; }

    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.78);
      padding:5px 8px;
      border-radius: 999px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
    }
    .chip .k{ color: rgba(255,255,255,.55); font-weight:700; margin-right:6px; }

    /* Posters */
    .item{
      display:grid;
      grid-template-columns: 48px 1fr;
      gap:10px;
      align-items:center;
    }
    .thumb{
      width:48px; height:64px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      object-fit: cover;
    }
    .thumb.ph{
      display:grid; place-items:center;
      font-size:10px;
      color: rgba(255,255,255,.55);
      text-align:center;
      padding:6px;
      line-height:1.1;
    }
    .posterPreview{
      display:none;
      width:100%;
      max-width:240px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      object-fit:cover;
    }
    .modalPoster{
      width: min(220px, 40vw);
      aspect-ratio: 2 / 3;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      object-fit: cover;
    }
    @media (max-width: 520px){
      .item{ grid-template-columns: 44px 1fr; }
      .thumb{ width:44px; height:58px; }
      .modalPoster{ width: min(160px, 44vw); }
    }

    .toast{
      position:fixed; left:50%; bottom:16px; transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      display:none;
      z-index:2000;
      max-width: min(700px, 92vw);
      text-align:center;
      font-size:13px;
    }
    .toast.show{ display:block; }

    .toast .twrap{ display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }
    .toast .tbtn{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(216,27,96,.85);
      color: rgba(255,255,255,.95);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .toast .tbtn:active{ transform: scale(.98); }


    .file{ display:none; }

    /* iOS Safari/WebView: file inputs cannot be display:none if you want .click() to open picker */
    .fileOffscreen{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
      pointer-events:none;
    }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    /* Simple modal */
    .modal{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(0,0,0,.62);
      padding:16px;
      z-index:1000;
    }
    .modal.open{ display:grid; }
    .sheet{
      width:min(720px, 100%);
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(20,22,30,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .sheet .top{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .sheet .body{
      padding:14px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1;
    }

    /* iOS keyboard safety: give bottom breathing room inside sheets */
    #collectionsSheet .body{ padding-bottom: calc(14px + env(safe-area-inset-bottom) + 120px); }
    .kv{ display:grid; gap:8px; }
    .kv .row{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:13px;
    }

    .kv .row.plot{
      flex-direction: column;
      align-items: flex-start;
    }
    .kv .row.plot .v{
      text-align: left;
      width: 100%;
      font-weight: 700;
      white-space: pre-wrap;
      line-height: 1.35;
    }
    .k{ color:var(--muted); }
    .v{ font-weight:800; text-align:right; }

    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.9);
    }

    .vsep{
      width:1px;
      height:28px;
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      margin:0 2px;
    }

    /* Modal motion (subtle) */
    .modal{
      opacity:0;
      transition: opacity .16s ease;
    }
    .modal.open{ opacity:1; }
    .sheet{
      transform: translateY(10px) scale(.99);
      transition: transform .16s ease;
    }
    .modal.open .sheet{
      transform: translateY(0) scale(1);
    }
    @media (prefers-reduced-motion: reduce){
      .modal, .sheet{ transition:none !important; }
    }
  
    .pickItem{
      display:flex; gap:12px; align-items:center;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
    }
    .pickItem:hover{ background: rgba(255,255,255,.06); }
    .pickPoster{
      width:44px; height:66px; border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden; flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.55); font-size:10px;
    }
    .pickPoster img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pickMeta{ min-width:0; }
    .pickTitle{ font-weight:900; }
    .pickSub{ color: rgba(255,255,255,.68); font-size:12px; margin-top:2px; }


    /* Collections */
    .collectionsGrid{
      display:grid;
      gap:10px;
      /* Center collections when there are only a few (looks nicer on big screens) */
      grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
      justify-content: center;
    }
    .collectionCard{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding:10px 10px;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .collectionCard:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.22);
      transform: translateY(-1px);
    }
    .collectionArt{
      width:48px; height:64px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      object-fit: contain;
      flex: 0 0 auto;
    }
    .collectionArt.ph{
      display:grid; place-items:center;
      color: rgba(255,255,255,.55);
      font-size:10px;
      text-align:center;
      line-height:1.1;
      padding:6px;
    }
    .collectionName{ font-weight:900; font-size:13px; }
    .collectionCount{ color:var(--muted); font-size:12px; margin-top:2px; }

    /* Collection reordering (drag/drop) */
    #collectionList.reorderMode .item{
      grid-template-columns: 26px 48px 1fr;
      cursor: grab;
    }
    .dragHandle{
      width:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:.72;
      font-size:18px;
      user-select:none;
      -webkit-user-select:none;
      cursor: grab;
    }
    #collectionList.reorderMode .item.dragging{ opacity:.35; }
    #collectionList.reorderMode .item.dragOver{
      outline: 2px dashed rgba(255,255,255,.35);
      outline-offset: 3px;
    }

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Movie Vault</h1>
        <div class="sub" id="buildSubtitle">Plain build — TMDb autofill (build " + APP_VERSION + ")</div>
      </div>
      <div class="row" style="gap:10px; align-items:center;">
        <button class="btn small primary" id="addMovieBtn" type="button">Add Movie</button>
        <button class="btn small ghost" id="collectionsBtn" type="button">Collections</button>
        <div class="vsep" aria-hidden="true"></div>
        <div class="toolsWrap" style="position:relative;">
          <button class="btn small ghost" id="toolsBtn" type="button" aria-haspopup="true" aria-expanded="false">Vault Backup ▾</button>
          <div class="toolsMenu" id="toolsMenu" role="menu" aria-label="Vault Backup">
            <button class="btn small ghost toolsItem" id="backupBtnTop" type="button" role="menuitem">Backup to Files…</button>
            <button class="btn small ghost toolsItem" id="restoreBtnTop" type="button" role="menuitem">Restore from Files…</button>
            <div class="sep" style="margin:8px 0;"></div>
            <button class="btn small ghost toolsItem" id="keysBtnTop" type="button" role="menuitem">API Keys…</button>
          </div>
          <input id="importFile" class="fileOffscreen" type="file" accept="application/json" />
        </div>
        <div class="pill" id="versionPill" style="opacity:.9;"></div>
        <div class="pill" id="countPill">0 movies</div>
      </div>
    </header>

    <div class="grid">
      <!-- List -->
      <section class="card">
        <div class="hd">
          <h2>Library</h2>
          <div class="row">
            <input id="q" placeholder="Search title/director…" style="max-width:260px;" />
            <select id="sort" class="btn small" style="padding:9px 10px;">
              <option value="added_desc">Newest</option>
              <option value="added_asc">Oldest</option>
              <option value="title_asc" selected>Title A→Z</option>
              <option value="title_desc">Title Z→A</option>
              <option value="release_desc">Release ↓</option>
              <option value="release_asc">Release ↑</option>
            </select>
          </div>
        </div>
        <div class="bd">
          <div id="azBar" class="azBar" aria-label="A to Z jump bar"></div>
          <div id="list" class="list"></div>
          <div id="empty" class="hint" style="display:none; padding:10px 2px;">
            Empty vault. Add your first movie on the left.
          </div>
        </div>
      </section>
    </div>
  </div>


  <!-- Add/Edit modal -->
  <div class="modal" id="formModal" role="dialog" aria-modal="true" aria-label="Add or edit movie">
    <div class="sheet" id="formSheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="formTitle">Add Movie</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;">Manual entry — posters optional</div>
        </div>
        <div class="row">
          <button class="btn small ghost" id="autoFillBtn" type="button">Auto-Fill</button>
          <button class="btn small ghost" id="formCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body stack">
        <div>
          <label for="title">Movie Title</label>
          <input id="title" placeholder="e.g., Jaws" autocomplete="off" />
        </div>

        <div class="row">
          <div class="grow">
            <label for="release">Release Date</label>
            <input id="release" placeholder="YYYY-MM-DD (or just year)" autocomplete="off" />
          </div>
        </div>

        <div>
          <label for="director">Director</label>
          <input id="director" placeholder="e.g., Steven Spielberg" autocomplete="off" />
        </div>

        
        <div>
          <label for="collectionSelect">Collection (optional)</label>
          <select id="collectionSelect" class="btn" style="width:100%; padding:12px;">
            <option value="">None</option>
          </select>
          <div class="hint">Tip: Collections are folders (Rocky, Alien, etc.). You can manage them in the Collections screen.</div>
        </div>

<div>
          <label for="cast">Cast (optional)</label>
          <input id="cast" placeholder="e.g., Sigourney Weaver, Tom Skerritt" autocomplete="off" />
          <div class="hint">Auto-Fill adds the top cast; you can edit it here.</div>
        </div>

        

        <div>
          <label for="plot">Plot</label>
          <textarea id="plot" placeholder="Short plot synopsis…" autocomplete="off"></textarea>
        </div>
<div>
          <label>Poster (optional)</label>
          <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn small ghost" id="posterBtn" type="button">Choose Poster…</button>
            <button class="btn small danger" id="posterRemoveBtn" type="button" style="display:none;">Remove</button>
            <input id="posterFile" class="fileOffscreen" type="file" accept="image/*" />
            <div class="hint" style="flex:1; min-width:220px;">Tip: JPG/PNG. Stored inside your vault (offline). Large images are auto-shrunk.</div>
          </div>
          <div style="margin-top:10px;">
            <img id="posterPreview" class="posterPreview" alt="Poster preview" />
          </div>
        </div>

        <div class="row">
          <button class="btn primary grow" id="saveBtn" type="button">Save Movie</button>
          <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Delete</button>
        </div>
        <div class="hint">Tip: Backups always use the same filename. Saving to the same folder will prompt you to replace the old file.</div>
      </div>
    </div>
  </div>

  <!-- Details modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Movie details">
    <div class="sheet" id="sheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="mTitle">—</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;" id="mSub">—</div>
        </div>
        <div class="row">
          <button class="btn small danger" id="modalDeleteBtn" type="button">Delete</button>
          <button class="btn small ghost" id="editBtn" type="button">Edit</button>
          <button class="btn small ghost" id="closeBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body">
        <div class="kv" id="mKv"></div>
      </div>
    </div>
  </div>

  
  <!-- API Keys modal -->
  <div class="modal" id="keysModal" role="dialog" aria-modal="true" aria-label="API keys">
    <div class="sheet" id="keysSheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">API Keys</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;">Stored locally on this device (LocalStorage). Keep your repo public-safe.</div>
        </div>
        <div class="row">
          <button class="btn small ghost" id="keysCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body stack">
        <div class="hint">These keys are required for Auto-Fill (TMDb only). Stored only in your browser on this device.</div>
        <div>
          <label for="tmdbKey">TMDb API Key</label>
          <input id="tmdbKey" placeholder="Paste TMDb key…" autocomplete="off" />
        </div>
<div class="row">
          <button class="btn primary grow" id="keysSaveBtn" type="button">Save Keys</button>
          <button class="btn danger" id="keysClearBtn" type="button">Clear</button>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Auto-Fill picker modal -->
  <div class="modal" id="pickModal" role="dialog" aria-modal="true" aria-label="Choose movie">
    <div class="sheet" id="pickSheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Choose the right movie</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;">Tap one result to auto-fill.</div>
        </div>
        <div class="row">
          <button class="btn small ghost" id="pickCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body">
        <div id="pickList" class="stack"></div>
      </div>
    </div>
  </div>


  <!-- Collections modal -->
  <div class="modal" id="collectionsModal" role="dialog" aria-modal="true" aria-label="Collections">
    <div class="sheet" id="collectionsSheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="collectionsTopTitle">Collections</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;" id="collectionsTopSub">Folders for franchises and series.</div>
        </div>
        <div class="row">
          <button class="btn small ghost" id="collectionsBackBtn" type="button" style="display:none;">Back</button>
          <button class="btn small ghost" id="collectionsCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body">

        <!-- List view -->
        <div id="collectionsListView">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px; flex-wrap:wrap;">
            <div class="hint" style="margin:0;">Create folders like “Rocky”, “Alien”, “Bond”, etc.</div>
            <button class="btn small primary" id="newCollectionBtn" type="button">New Collection</button>
          </div>
          <div id="collectionsGrid" class="collectionsGrid"></div>
          <div id="collectionsEmpty" class="hint" style="display:none; padding:10px 2px;">No collections yet.</div>
        </div>

        <!-- Detail view -->
        <div id="collectionDetailView" class="stack" style="display:none;">
          <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="grow" style="min-width:220px;">
              <div style="font-weight:900; font-size:14px;" id="collectionNameTitle">—</div>
              <div class="hint" id="collectionCountHint">—</div>
            </div>
            <button class="btn small ghost" id="collectionOrderBtn" type="button">Edit</button>
            <button class="btn small ghost" id="collectionEditBtn" type="button">Edit Info</button>
          </div>

          <div class="row" style="gap:10px;">
            <button class="btn small primary grow" id="collectionAddExistingBtn" type="button">Add Existing</button>
            <button class="btn small ghost grow" id="collectionAddNewBtn" type="button">Add New</button>
          </div>

          <div class="row" style="gap:10px;">
            <input id="collectionQ" placeholder="Search within this collection…" class="grow" />
            <select id="collectionSort" class="btn small" style="padding:9px 10px;">
              <option value="custom" selected>Collection Order</option>
              <option value="release_asc">Release ↑</option>
              <option value="release_desc">Release ↓</option>
              <option value="title_asc">Title A→Z</option>
              <option value="title_desc">Title Z→A</option>
            </select>
          </div>

          <div id="collectionList" class="list"></div>
          <div id="collectionEmpty" class="hint" style="display:none; padding:10px 2px;">This collection is empty.</div>
        </div>

        <!-- Edit collection panel -->
        <div id="collectionEditPanel" class="stack" style="display:none;">
          <div>
            <label for="collectionNameInput">Collection Name</label>
            <input id="collectionNameInput" placeholder="e.g., Rocky" autocomplete="off" />
          </div>

          <div>
            <label>Artwork (optional)</label>
            <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
              <button class="btn small ghost" id="collectionArtBtn" type="button">Choose Artwork…</button>
              <button class="btn small danger" id="collectionArtRemoveBtn" type="button" style="display:none;">Remove</button>
              <input id="collectionArtFile" class="fileOffscreen" type="file" accept="image/*" />
              <div class="hint" style="flex:1; min-width:220px;">Tip: Use a franchise poster or logo.</div>
            </div>
            <div style="margin-top:10px;">
              <img id="collectionArtPreview" class="posterPreview" alt="Collection artwork preview" />
            </div>
          </div>

          <div class="row">
            <button class="btn primary grow" id="collectionSaveBtn" type="button">Save</button>
            <button class="btn danger" id="collectionDeleteBtn" type="button">Delete</button>
          </div>
          <div class="hint">Deleting a collection does not delete movies. It just unfiles them.</div>
        </div>

        <!-- Add existing picker -->
        <div id="collectionPickPanel" class="stack" style="display:none;">
          <div class="row">
            <input id="collectionPickQ" placeholder="Search your vault…" class="grow" />
          </div>
          <div id="collectionPickList" class="stack"></div>
          <div id="collectionPickEmpty" class="hint" style="display:none; padding:10px 2px;">No matching movies.</div>
        </div>

      </div>
    </div>
  </div>


  <div class="toast" id="toast"></div>

<script>

function getTopCastFromCredits(credits, max = 3) {
  if (!credits || !credits.cast) return '';
  return credits.cast
    .slice(0, max)
    .map(c => c.name)
    .join(', ');
}

function getFullCastFromCredits(credits, max = 15) {
  if (!credits || !credits.cast) return "";
  return credits.cast
    .slice(0, max)
    .map(c => c.name)
    .join(", ");
}


function titleKey(movie) {
  // Normalized title for sorting/searching (ignores leading articles).
  const t = (movie && movie.title) ? String(movie.title) : "";
  return t.replace(/^(the\s+|a\s+|an\s+)/i, "").trim().toLowerCase();
}

const APP_VERSION = "v2.0.49-editmode-reorder-remove";

  function applyAppVersion(){
    try{
      const vp = document.getElementById("versionPill");
      if (vp) vp.textContent = APP_VERSION;
      const sub = document.getElementById("buildSubtitle");
      if (sub) sub.textContent = `Plain build — TMDb autofill (${APP_VERSION})`;
    }catch(e){}
  }


// Safe HTML escaping (prevents broken UI / injection)
function escapeHtml(str){
  if(str === null || str === undefined) return "";
  return String(str).replace(/[&<>\"\']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","\'":"&#39;"}[c]));
}

// UID helper (shared). Needed by Collections; iOS Safari will throw if missing.
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}


/* =========================================================
   Movie Vault (Plain)
   Clean layers: Config • Store • UI • App
   Manual entry only (no TMDb)
   ========================================================= */

/* 1) Config */
const Config = (() => {
  const VERSION = "2.0.6";
  const STORAGE_KEY = "movie_vault_plain_v1"; // fresh start
  return { VERSION, STORAGE_KEY };
})();


/* 1.5) API (Hybrid Auto-Fill: TMDb → IMDb → OMDb) */
const Api = (() => {
  const KEY_STORAGE = "movie_vault_api_keys_v1";
  function loadKeys(){
    try{
      const raw = localStorage.getItem(KEY_STORAGE);
      if(!raw) return { tmdb:"" };
      const k = JSON.parse(raw);
      return { tmdb: String(k.tmdb||"") };
    }catch(_){
      return { tmdb:"" };
    }
  }
  function saveKeys(keys){
    localStorage.setItem(KEY_STORAGE, JSON.stringify({ tmdb: keys.tmdb||"", omdb: keys.omdb||"" }));
  }
  function clearKeys(){ localStorage.removeItem(KEY_STORAGE); }

  async function tmdbSearch(title, year, tmdbKey){
    const params = new URLSearchParams({
      api_key: tmdbKey,
      query: title,
      include_adult: "false",
      language: "en-US"
    });
    if(year) params.set("year", year);
    const url = "https://api.themoviedb.org/3/search/movie?" + params.toString();
    const r = await fetch(url);
    if(!r.ok) throw new Error("TMDb search failed.");
    return r.json();
  }

  async function tmdbDetails(movieId, tmdbKey){
    const params = new URLSearchParams({
      api_key: tmdbKey,
      language: "en-US",
      append_to_response: "external_ids"
    });
    const url = "https://api.themoviedb.org/3/movie/" + encodeURIComponent(movieId) + "?" + params.toString();
    const r = await fetch(url);
    if(!r.ok) throw new Error("TMDb details failed.");
    return r.json();
  }

  async function omdbByImdb(imdbId, omdbKey){
    const params = new URLSearchParams({
      apikey: omdbKey,
      i: imdbId,
      plot: "short"
    });
    const url = "https://www.omdbapi.com/?" + params.toString();
    let r;
    try{
      r = await fetch(url, { cache: "no-store" });
    }catch(e){
      throw new Error("OMDb network error (check internet/DNS).");
    }
    if(!r.ok){
      let body = "";
      try{ body = (await r.text() || "").slice(0,120); }catch(_){}
      throw new Error(`OMDb HTTP ${r.status}${body ? " — " + body : ""}`);
    }
    const j = await r.json();
    if(j && j.Response === "False") throw new Error(j.Error || "OMDb returned no result.");
    return j;
  }

  async function omdbByTitle(title, year, omdbKey){
    const params = new URLSearchParams({
      apikey: omdbKey,
      t: title,
      plot: "short"
    });
    if(year) params.set("y", year);
    const url = "https://www.omdbapi.com/?" + params.toString();
    let r;
    try{
      r = await fetch(url, { cache: "no-store" });
    }catch(e){
      throw new Error("OMDb network error (check internet/DNS).");
    }
    if(!r.ok){
      let body = "";
      try{ body = (await r.text() || "").slice(0,120); }catch(_){}
      throw new Error(`OMDb HTTP ${r.status}${body ? " — " + body : ""}`);
    }
    const j = await r.json();
    if(j && j.Response === "False") throw new Error(j.Error || "OMDb returned no result.");
    return j;
  }

  async function tmdbCredits(movieId, tmdbKey){
    const params = new URLSearchParams({ api_key: tmdbKey, language: "en-US" });
    const url = "https://api.themoviedb.org/3/movie/" + encodeURIComponent(movieId) + "/credits?" + params.toString();
    const r = await fetch(url);
    if(!r.ok) throw new Error("TMDb credits failed.");
    return r.json();
  }

  function tmdbPosterUrl(path){
    if(!path) return "";
    return "https://image.tmdb.org/t/p/w500" + path;
  }

  return { loadKeys, saveKeys, clearKeys, tmdbSearch, tmdbDetails, tmdbCredits, tmdbPosterUrl };
})();


/* 2) Store */
const Store = (() => {
  let mem = null;

  function canLocalStorage(){
    try{
      const k="__mv_plain_test__";
      localStorage.setItem(k,"1");
      localStorage.removeItem(k);
      return true;
    }catch(_){ return false; }
  }
  const ok = canLocalStorage();

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function normalize(m){
    const now = Date.now();
    return {
      id: (m && m.id) ? String(m.id) : uid(),
      title: (m && m.title) ? String(m.title).trim() : "",
      release: (m && m.release) ? String(m.release).trim() : "",
      director: (m && m.director) ? String(m.director).trim() : "",
      cast: (m && m.cast) ? String(m.cast).trim() : "",
      fullCast: (m && m.fullCast) ? String(m.fullCast).trim() : "",
      plot: (m && m.plot) ? String(m.plot).trim() : "",
      poster: (m && m.poster) ? String(m.poster) : "", // data URL (embedded)
      collectionId: (m && m.collectionId !== undefined && m.collectionId !== null) ? String(m.collectionId) : "",
      createdAt: (m && m.createdAt) ? Number(m.createdAt) : now,
      updatedAt: (m && m.updatedAt) ? Number(m.updatedAt) : now,
    };
  }

  function load(){
    try{
      const raw = ok ? localStorage.getItem(Config.STORAGE_KEY) : mem;
      if(!raw) return { movies: [], collections: [] };
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.movies)) return { movies: [], collections: [] };
      parsed.movies = parsed.movies.map(normalize);
      if(!Array.isArray(parsed.collections)) parsed.collections = [];
      parsed.collections = parsed.collections.map(c => ({
        id: String(c && c.id || ""),
        name: String(c && c.name || "").trim(),
        artwork: String(c && c.artwork || ""),
        sortMode: String(c && c.sortMode || "custom"),
        customOrder: Array.isArray(c && c.customOrder) ? c.customOrder.map(String) : [],
        createdAt: Number(c && c.createdAt || Date.now()),
        updatedAt: Number(c && c.updatedAt || Date.now()),
      })).filter(c => c.id && c.name);
      return parsed;
    }catch(_){
      return { movies: [], collections: [] };
    }
  }

  function save(state){
    try{
      const raw = JSON.stringify(state);
      if(ok) localStorage.setItem(Config.STORAGE_KEY, raw);
      else mem = raw;
      return true;
    }catch(_){
      return false;
    }
  }

  function makeExportFile(state){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    // File helps iOS share sheet understand what it is
    const ver = (APP_VERSION || "").replace(/^v/,"");
    return new File([blob], `MovieVaultBackup_${ver}.json`, { type: "application/json" });
  }

  function downloadExport(state){
    const file = makeExportFile(state);
    const url = URL.createObjectURL(file);
    const a = document.createElement("a");
    a.href = url;
    a.download = file.name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importJSON(file){
    const text = await file.text();
    const parsed = JSON.parse(text);
    if(!parsed || !Array.isArray(parsed.movies)) throw new Error("Invalid file: expected { movies: [...] }");
    parsed.movies = parsed.movies.map(normalize);
    return parsed;
  }

  return { ok, normalize, load, save, makeExportFile, downloadExport, importJSON };
})();

/* 3) UI */
const UI = (() => {
  const el = {
    title: document.getElementById("title"),
    release: document.getElementById("release"),
    director: document.getElementById("director"),
    collectionSelect: document.getElementById("collectionSelect"),
    cast: document.getElementById("cast"),
    plot: document.getElementById("plot"),
    // posters
    posterBtn: document.getElementById("posterBtn"),
    posterRemoveBtn: document.getElementById("posterRemoveBtn"),
    posterFile: document.getElementById("posterFile"),
    posterPreview: document.getElementById("posterPreview"),
    saveBtn: document.getElementById("saveBtn"),
    deleteBtn: document.getElementById("deleteBtn"),
    importFile: document.getElementById("importFile"),
    formTitle: document.getElementById("formTitle"),
    q: document.getElementById("q"),
    sort: document.getElementById("sort"),
    list: document.getElementById("list"),
    empty: document.getElementById("empty"),
    versionPill: document.getElementById("versionPill"),
    countPill: document.getElementById("countPill"),
    // add/edit modal
    addMovieBtn: document.getElementById("addMovieBtn"),
    collectionsBtn: document.getElementById("collectionsBtn"),
    formModal: document.getElementById("formModal"),
    formSheet: document.getElementById("formSheet"),
    formCloseBtn: document.getElementById("formCloseBtn"),
    // tools
    toolsBtn: document.getElementById("toolsBtn"),
    toolsMenu: document.getElementById("toolsMenu"),
    backupBtnTop: document.getElementById("backupBtnTop"),
    restoreBtnTop: document.getElementById("restoreBtnTop"),

    autoFillBtn: document.getElementById("autoFillBtn"),
    // keys
    keysBtnTop: document.getElementById("keysBtnTop"),
    keysModal: document.getElementById("keysModal"),
    keysSheet: document.getElementById("keysSheet"),
    keysCloseBtn: document.getElementById("keysCloseBtn"),
    keysSaveBtn: document.getElementById("keysSaveBtn"),
    keysClearBtn: document.getElementById("keysClearBtn"),
    tmdbKey: document.getElementById("tmdbKey"),
    // autofill picker
    pickModal: document.getElementById("pickModal"),
    pickSheet: document.getElementById("pickSheet"),
    pickCloseBtn: document.getElementById("pickCloseBtn"),
    pickList: document.getElementById("pickList"),
    azBar: document.getElementById("azBar"),
    toast: document.getElementById("toast"),
    // collections
    collectionsModal: document.getElementById("collectionsModal"),
    collectionsSheet: document.getElementById("collectionsSheet"),
    collectionsCloseBtn: document.getElementById("collectionsCloseBtn"),
    collectionsBackBtn: document.getElementById("collectionsBackBtn"),
    collectionsTopTitle: document.getElementById("collectionsTopTitle"),
    collectionsTopSub: document.getElementById("collectionsTopSub"),
    newCollectionBtn: document.getElementById("newCollectionBtn"),
    collectionsGrid: document.getElementById("collectionsGrid"),
    collectionsEmpty: document.getElementById("collectionsEmpty"),
    collectionsListView: document.getElementById("collectionsListView"),
    collectionDetailView: document.getElementById("collectionDetailView"),
    collectionNameTitle: document.getElementById("collectionNameTitle"),
    collectionCountHint: document.getElementById("collectionCountHint"),
    collectionOrderBtn: document.getElementById("collectionOrderBtn"),
    collectionEditBtn: document.getElementById("collectionEditBtn"),
    collectionAddExistingBtn: document.getElementById("collectionAddExistingBtn"),
    collectionAddNewBtn: document.getElementById("collectionAddNewBtn"),
    collectionQ: document.getElementById("collectionQ"),
    collectionSort: document.getElementById("collectionSort"),
    collectionList: document.getElementById("collectionList"),
    collectionEmpty: document.getElementById("collectionEmpty"),
    collectionEditPanel: document.getElementById("collectionEditPanel"),
    collectionNameInput: document.getElementById("collectionNameInput"),
    collectionArtBtn: document.getElementById("collectionArtBtn"),
    collectionArtRemoveBtn: document.getElementById("collectionArtRemoveBtn"),
    collectionArtFile: document.getElementById("collectionArtFile"),
    collectionArtPreview: document.getElementById("collectionArtPreview"),
    collectionSaveBtn: document.getElementById("collectionSaveBtn"),
    collectionDeleteBtn: document.getElementById("collectionDeleteBtn"),
    collectionPickPanel: document.getElementById("collectionPickPanel"),
    collectionPickQ: document.getElementById("collectionPickQ"),
    collectionPickList: document.getElementById("collectionPickList"),
    collectionPickEmpty: document.getElementById("collectionPickEmpty"),

    // modal
    modal: document.getElementById("modal"),
    sheet: document.getElementById("sheet"),
    mTitle: document.getElementById("mTitle"),
    mSub: document.getElementById("mSub"),
    mKv: document.getElementById("mKv"),
    closeBtn: document.getElementById("closeBtn"),
    editBtn: document.getElementById("editBtn"),
    modalDeleteBtn: document.getElementById("modalDeleteBtn"),
  };

  let toastTimer = null;
  function toast(msg){
    // plain text toast
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.toast.classList.remove("show"), 2200);
  }

  function toastAction(msg, actionLabel, onAction, ms=5000){
    // toast with a single action button (e.g., Undo)
    clearTimeout(toastTimer);
    el.toast.innerHTML = `<span class="twrap"><span>${esc(msg)}</span><button type="button" class="tbtn">${esc(actionLabel||'OK')}</button></span>`;
    const btn = el.toast.querySelector('.tbtn');
    if(btn){
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        try{ onAction && onAction(); }catch(_){ }
        el.toast.classList.remove("show");
      }, { once:true });
    }
    el.toast.classList.add("show");
    toastTimer = setTimeout(() => el.toast.classList.remove("show"), ms);
  }

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function formatReleaseDate(dateStr){
    if(!dateStr) return "—";
    const d = new Date(dateStr);
    if(Number.isNaN(d.getTime())) return String(dateStr);
    // Example style: Dec 25 1964
    return d.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"}).replace(/,/g,"");
  }

  function setCount(n){ el.countPill.textContent = (n===1) ? "1 movie" : `${n} movies`; }

  function setEditMode(on){
    el.formTitle.textContent = on ? "Edit Movie" : "Add Movie";
    el.saveBtn.textContent = on ? "Update Movie" : "Save Movie";
    el.deleteBtn.style.display = on ? "inline-flex" : "none";
  }

  function fillForm(m){
    el.title.value = m.title || "";
    el.release.value = m.release || "";
    el.director.value = m.director || "";
    if(el.collectionSelect){
      // options are refreshed in App; set value if present
      el.collectionSelect.value = (m.collectionId || "");
    }
    if(el.cast) el.cast.value = m.cast || "";
    if(el.plot) el.plot.value = m.plot || "";
  }
  function clearForm(){
    el.title.value = "";
    el.release.value = "";
    el.director.value = "";
    if(el.collectionSelect) el.collectionSelect.value = "";
    if(el.cast) el.cast.value = "";
    if(el.plot) el.plot.value = "";
    if(el.posterPreview){
      el.posterPreview.src = "";
      el.posterPreview.style.display = "none";
    }
    if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "none";
    if(el.posterFile) el.posterFile.value = "";
  }

  function setPosterPreview(dataUrl){
    if(dataUrl){
      if(el.posterPreview){
        el.posterPreview.src = dataUrl;
        el.posterPreview.style.display = "block";
      }
      if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "inline-flex";
    }else{
      if(el.posterPreview){
        el.posterPreview.src = "";
        el.posterPreview.style.display = "none";
      }
      if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "none";
      if(el.posterFile) el.posterFile.value = "";
    }
  }

  function renderList(movies){
    const handle = "";
    el.list.innerHTML = "";
    el.empty.style.display = movies.length ? "none" : "block";

    // Insert lightweight A/B/C... section headers based on the same navigation key
    // used by the A–Z bar (ignores leading The / A / An).
    let prevL = null;

    for(const m of movies){
      const L = (typeof letterKeyFromTitle === "function") ? letterKeyFromTitle(m.title) : "#";
      if(L !== prevL){
        const h = document.createElement("div");
        h.className = "azHeader";
        h.dataset.letter = L;
        h.textContent = L;
        el.list.appendChild(h);
        prevL = L;
      }

      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = m.id;
      const thumb = m.poster
        ? `<img class="thumb" alt="Poster" src="${esc(m.poster)}" />`
        : `<div class="thumb ph">NO<br/>POSTER</div>`;

      const year = (m.release || "").trim().slice(0,4);
      const yearSafe = (/^[0-9]{4}$/.test(year) ? year : "—");

      div.innerHTML = `
        ${handle}
        ${thumb}
        <div>
          <div class="title">${esc(m.title || "(Untitled)")}</div>
          <div class="meta"><b>${esc(yearSafe)}</b></div>
        </div>
      `;
      el.list.appendChild(div);
    }
  }



  function renderAZBar(enabledSet, activeLetter){
    if(!el.azBar) return;
    const letters = [];
    for(let i=65;i<=90;i++) letters.push(String.fromCharCode(i));
    letters.push('#');

    const btns = letters.map(L => {
      const enabled = enabledSet && enabledSet.has(L);
      const cls = ["azBtn", enabled?"":"disabled", (activeLetter===L)?"active":""].filter(Boolean).join(" ");
      return `<button class="${cls}" type="button" data-letter="${L}" aria-label="Jump to ${L}">${L}</button>`;
    }).join("");

    el.azBar.innerHTML = btns;
  }

  function openFormModal(){ el.formModal.classList.add("open"); }
  function closeFormModal(){ el.formModal.classList.remove("open"); }

  function openKeysModal(){ el.keysModal && el.keysModal.classList.add("open"); }
  function closeKeysModal(){ el.keysModal && el.keysModal.classList.remove("open"); }

  function openPickModal(){ el.pickModal && el.pickModal.classList.add("open"); }
  function closePickModal(){ el.pickModal && el.pickModal.classList.remove("open"); }

  function openModal(m){
    const prettyRelease = formatReleaseDate(m.release);
    el.mTitle.textContent = m.title || "(Untitled)";
    el.mSub.textContent = (prettyRelease && prettyRelease !== "—") ? `Release: ${prettyRelease}` : "—";
    const poster = m.poster
      ? `<img class="modalPoster" alt="Poster" src="${esc(m.poster)}" />`
      : `<div class="modalPoster" style="display:grid; place-items:center; color:rgba(255,255,255,.55); font-size:12px;">No poster</div>`;

    el.mKv.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-bottom:12px;">
        ${poster}
        <div style="flex:1; min-width:240px;" class="kv">
          <div class="row"><div class="k">Title</div><div class="v">${esc(m.title || "—")}</div></div>
          <div class="row"><div class="k">Release</div><div class="v">${esc(prettyRelease || "—")}</div></div>
          <div class="row"><div class="k">Director</div><div class="v">${esc(m.director || "—")}</div></div>
          <div class="row"><div class="k">Cast</div><div class="v">${esc(m.fullCast || m.cast || "—")}</div></div>
          <div class="row plot"><div class="k">Plot</div><div class="v">${esc(m.plot || "—")}</div></div>
        </div>
      </div>
    `;
    el.modal.classList.add("open");
  }
  function closeModal(){ el.modal.classList.remove("open"); }


  function setVersion(v){
    if(el.versionPill) el.versionPill.textContent = v || "";
  }

  return { el, toast, toastAction, setVersion, setCount, setEditMode, fillForm, clearForm, setPosterPreview, renderList, renderAZBar, openFormModal, closeFormModal, openKeysModal, closeKeysModal, openPickModal, closePickModal, openModal, closeModal };
})();

/* 4) App */
const App = (() => {
  let state = Store.load();
  // --- Collections (full system: folders + optional artwork; custom ordering later) ---
  function escH(s){ return String(s ?? "").replace(/[&<>"\']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","\'":"&#39;" }[c])); }
  function getCollection(id){ return state.collections.find(c => c.id === id) || null; }

  function refreshCollectionSelectOptions(selectedId){
    if(!UI.el.collectionSelect) return;
    const sel = UI.el.collectionSelect;
    const keep = (selectedId !== undefined) ? String(selectedId||"") : String(sel.value||"");
    sel.innerHTML = '<option value="">None</option>';
    const cols = (state.collections || []).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"}));
    for(const c of cols){
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    }
    sel.value = keep;
  }

  function removeFromCustomOrder(collectionId, movieId){
    const col = getCollection(collectionId);
    if(!col) return;
    col.customOrder = Array.isArray(col.customOrder) ? col.customOrder.filter(id => id !== movieId) : [];
    col.updatedAt = Date.now();
  }

  function addToCustomOrder(collectionId, movieId){
    const col = getCollection(collectionId);
    if(!col) return;
    if(!Array.isArray(col.customOrder)) col.customOrder = [];
    if(!col.customOrder.includes(movieId)) col.customOrder.push(movieId);
    col.updatedAt = Date.now();
  }

  function setMovieCollection(movieId, newCollectionId, oldCollectionId){
    const oldId = (oldCollectionId !== undefined) ? String(oldCollectionId||"") : (getMovie(movieId)?.collectionId || "");
    const newId = String(newCollectionId||"");

    if(oldId && oldId !== newId) removeFromCustomOrder(oldId, movieId);
    if(newId) addToCustomOrder(newId, movieId);

    const m = getMovie(movieId);
    if(m) m.collectionId = newId;
  }

  // Collections modal view state
  let collectionsView = "list"; // list | detail | edit | pick
  let currentCollectionId = "";
  let tempCollectionArtwork = "";
  let collectionReorderMode = false;
  let dragMovieId = "";

  function openCollections(){
    collectionsView = "list";
    currentCollectionId = "";
    showCollectionsView();
    UI.el.collectionsModal.classList.add("open");
  }

  function closeCollections(){
    UI.el.collectionsModal.classList.remove("open");
  }

  function showCollectionsView(){
    const el = UI.el;
    // default hide all
    el.collectionsListView.style.display = "none";
    el.collectionDetailView.style.display = "none";
    el.collectionEditPanel.style.display = "none";
    el.collectionPickPanel.style.display = "none";

    el.collectionsBackBtn.style.display = (collectionsView === "list") ? "none" : "inline-flex";

    if(collectionsView === "list"){
      el.collectionsTopTitle.textContent = "Collections";
      el.collectionsTopSub.textContent = "Folders for franchises and series.";
      el.collectionsListView.style.display = "block";
      renderCollectionsGrid();
      return;
    }

    const col = getCollection(currentCollectionId);
    if(collectionsView === "detail" && col){
      el.collectionsTopTitle.textContent = col.name;
      el.collectionsTopSub.textContent = "Movies in this collection.";
      el.collectionDetailView.style.display = "block";
      el.collectionNameTitle.textContent = col.name;
      // entering detail always starts in normal (non-reorder) mode
      collectionReorderMode = false;
      dragMovieId = "";
      if(el.collectionOrderBtn) el.collectionOrderBtn.textContent = "Reorder";
      el.collectionQ.disabled = false;
      el.collectionSort.disabled = false;
      el.collectionQ.value = "";
      el.collectionSort.value = "custom";
      renderCollectionDetail();
      return;
    }

    if(collectionsView === "edit"){
      el.collectionsTopTitle.textContent = (currentCollectionId ? "Edit Collection" : "New Collection");
      el.collectionsTopSub.textContent = "Name + optional artwork.";
      el.collectionEditPanel.style.display = "block";
      const existing = currentCollectionId ? getCollection(currentCollectionId) : null;
      el.collectionNameInput.value = existing ? existing.name : "";
      tempCollectionArtwork = existing ? (existing.artwork||"") : "";
      syncCollectionArtUI();
      // iOS: ensure name + buttons are reachable even with keyboard
      window.setTimeout(() => {
        try{ el.collectionNameInput.focus(); }catch(_){ }
        try{ el.collectionNameInput.scrollIntoView({ block: "center", behavior: "smooth" }); }catch(_){ }
      }, 50);
      return;
    }

    if(collectionsView === "pick" && col){
      el.collectionsTopTitle.textContent = "Add Existing";
      el.collectionsTopSub.textContent = "Pick a movie to move into “" + col.name + "”.";
      el.collectionPickPanel.style.display = "block";
      el.collectionPickQ.value = "";
      if(el.collectionPickEmpty) el.collectionPickEmpty.textContent = "No matching movies.";
      renderCollectionPick();
      // iOS Safari sometimes needs a tick after display change
      window.setTimeout(renderCollectionPick, 0);
      return;
    }

    // fallback
    collectionsView = "list";
    currentCollectionId = "";
    showCollectionsView();
  }

  function renderCollectionsGrid(){
    const grid = UI.el.collectionsGrid;
    grid.innerHTML = "";
    const cols = (state.collections || []).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"}));
    UI.el.collectionsEmpty.style.display = cols.length ? "none" : "block";

    for(const c of cols){
      const card = document.createElement("div");
      card.className = "collectionCard";
      card.dataset.id = c.id;

      let artNode;
      if(c.artwork){
        artNode = document.createElement("img");
        artNode.className = "collectionArt";
        artNode.alt = "Artwork";
        artNode.src = c.artwork;
      }else{
        artNode = document.createElement("div");
        artNode.className = "collectionArt ph";
        artNode.innerHTML = "NO<br/>ART";
      }

      const meta = document.createElement("div");
      const name = document.createElement("div");
      name.className = "collectionName";
      name.textContent = c.name;

      const count = document.createElement("div");
      count.className = "collectionCount";
      const n = state.movies.filter(m => (m.collectionId||"") === c.id).length;
      count.textContent = n + (n===1 ? " movie" : " movies");

      meta.appendChild(name);
      meta.appendChild(count);

      card.appendChild(artNode);
      card.appendChild(meta);

      grid.appendChild(card);
    }
  }

  function getMoviesInCollection(colId){
    return state.movies.filter(m => (m.collectionId||"") === colId);
  }

  function titleSort(a,b,dir){
    const A = titleKey(a.title||"");
    const B = titleKey(b.title||"");
    const d = (A.localeCompare(B, undefined, {sensitivity:"base"}) || String(a.id).localeCompare(String(b.id)));
    return dir === "desc" ? -d : d;
  }

  function releaseYear(m){
    const y = String(m.release||"").trim().slice(0,4);
    return (/^[0-9]{4}$/.test(y)) ? Number(y) : 9999;
  }


function getCollectionMoviesFilteredAndSorted(col){
    const q = (UI.el.collectionQ.value||"").trim().toLowerCase();
    let movies = getMoviesInCollection(col.id).slice();

    if(q){
      movies = movies.filter(m => {
        const t = String(m.title||"").toLowerCase();
        const r = String(m.release||"").toLowerCase();
        return t.includes(q) || r.includes(q);
      });
    }

    // Keep customOrder sane: include all movies in the collection, remove ones no longer in it.
    if(!Array.isArray(col.customOrder)) col.customOrder = [];
    const fullIds = getMoviesInCollection(col.id).map(m => String(m.id));
    let changed = false;

    // append missing
    for(const id of fullIds){
      if(!col.customOrder.includes(id)){
        col.customOrder.push(id);
        changed = true;
      }
    }
    // remove non-members
    const pruned = col.customOrder.filter(id => fullIds.includes(String(id)));
    if(pruned.length !== col.customOrder.length){
      col.customOrder = pruned;
      changed = true;
    }
    if(changed) col.updatedAt = Date.now();

    const sortMode = (UI.el.collectionSort.value||"custom");
    if(sortMode === "custom"){
      const orderMap = new Map(col.customOrder.map((id, i) => [String(id), i]));
      movies.sort((a,b)=>{
        const ia = orderMap.has(String(a.id)) ? orderMap.get(String(a.id)) : 1e9;
        const ib = orderMap.has(String(b.id)) ? orderMap.get(String(b.id)) : 1e9;
        if(ia !== ib) return ia - ib;
        return titleSort(a,b,"asc");
      });
    }else if(sortMode === "release"){
      movies.sort((a,b)=> (releaseYear(a) - releaseYear(b)) || titleSort(a,b,"asc"));
    }else{ // title
      movies.sort((a,b)=> titleSort(a,b,"asc"));
    }

    return { movies };
  }

  function renderCollectionDetail(){
    const col = getCollection(currentCollectionId);
    if(!col){
      collectionsView = "list";
      currentCollectionId = "";
      showCollectionsView();
      return;
    }

    const result = getCollectionMoviesFilteredAndSorted(col);
    const movies = result.movies;

    UI.el.collectionCountHint.textContent = movies.length + (movies.length===1 ? " movie" : " movies");
    const list = UI.el.collectionList;
    list.classList.toggle("reorderMode", collectionReorderMode);
    list.innerHTML = "";
    UI.el.collectionEmpty.style.display = movies.length ? "none" : "block";

    for(const m of movies){
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = m.id;
      div.draggable = !!collectionReorderMode;

      const handle = collectionReorderMode ? `<div class="dragHandle" aria-hidden="true">≡</div>` : ``;

      const thumb = m.poster
        ? `<img class="thumb" alt="Poster" src="${escH(m.poster)}" />`
        : `<div class="thumb ph">NO<br/>POSTER</div>`;

      const year = (m.release || "").trim().slice(0,4);
      const yearSafe = (/^[0-9]{4}$/.test(year) ? year : "—");

      div.innerHTML = `
        ${handle}
        ${thumb}
        <div>
          <div class="itemTop">
            <div class="title">${escH(m.title || "(Untitled)")}</div>
            ${collectionReorderMode ? `<button type="button" class="btn small danger removeFromCollectionBtn" title="Remove from collection">Remove</button>` : ``}
          </div>
          <div class="meta"><b>${escH(yearSafe)}</b></div>
        </div>
      `;
      list.appendChild(div);
    }
  }

  function toggleCollectionReorder(){
    const col = getCollection(currentCollectionId);
    if(!col) return;

    collectionReorderMode = !collectionReorderMode;
    dragMovieId = "";

    if(UI.el.collectionOrderBtn){
      UI.el.collectionOrderBtn.textContent = collectionReorderMode ? "Done" : "Edit";
    }
    UI.el.collectionQ.disabled = collectionReorderMode;
    UI.el.collectionSort.disabled = collectionReorderMode;

    // Re-render to apply draggable + handle UI
    renderCollectionDetail();
    UI.toast(collectionReorderMode ? "Edit mode: drag to reorder or tap Remove." : "Edits saved.");
  }

  function renderCollectionPick(){
  try{
    const col = getCollection(currentCollectionId);
    if(!col) return;

    const q = (UI.el.collectionPickQ.value||"").trim().toLowerCase();
    let movies = (Array.isArray(state.movies) ? state.movies : []).slice();

    if(q){
      movies = movies.filter(m => (m.title||"").toLowerCase().includes(q) || (m.release||"").toLowerCase().includes(q));
    }

    movies.sort((a,b)=> titleSort(a,b,"asc"));

    const list = UI.el.collectionPickList;
    list.innerHTML = "";
    UI.el.collectionPickEmpty.style.display = movies.length ? "none" : "block";

    for(const m of movies){
      const row = document.createElement("div");
      row.className = "row";
      row.style.gap = "10px";
      row.style.alignItems = "center";

      const label = document.createElement("div");
      label.className = "grow";
      const inCol = (m.collectionId||"") === col.id;
      const current = m.collectionId ? (getCollection(m.collectionId)?.name || "Other collection") : "Unfiled";
      label.innerHTML = `<div style="font-weight:800;">${escH(m.title||"(Untitled)")}</div>
                         <div class="hint" style="margin:2px 0 0 0;">${escH((m.release||"").trim().slice(0,4)||"—")} · ${inCol ? "Already here" : "Currently: " + current}</div>`;

      const btn = document.createElement("button");
      btn.className = "btn small " + (inCol ? "ghost" : "primary");
      btn.type = "button";
      btn.textContent = inCol ? "Added" : "Add";
      btn.disabled = inCol;
      btn.addEventListener("click", () => {
        try{
          // Ensure we are not in reorder mode when moving movies via picker
          if(typeof collectionReorderMode !== "undefined" && collectionReorderMode){
            collectionReorderMode = false;
            dragMovieId = "";
            if(UI.el.collectionOrderBtn) UI.el.collectionOrderBtn.textContent = "Reorder";
          }

          const prevColId = m.collectionId || "";
          setMovieCollection(m.id, col.id, prevColId);
          Store.save(state);

          // Keep collection dropdowns in sync (Edit Movie modal) if present
          try{ refreshCollectionSelectOptions(UI.el.collectionSelect ? UI.el.collectionSelect.value : ""); }catch(_){}

          UI.toast("Added to " + col.name + ".");

          // Stay in the picker so you can add multiple movies quickly
          renderCollectionPick();
          try{ UI.el.collectionPickQ && UI.el.collectionPickQ.focus(); }catch(_){ }
        }catch(err){
          console.error(err);
          UI.toast("Could not add existing movie: " + (err && err.message ? err.message : String(err)));
        }
      });

      row.appendChild(label);
      row.appendChild(btn);
      list.appendChild(row);
    }
  }catch(err){
    console.error(err);
    try{ UI.toast("Picker error: " + (err && err.message ? err.message : String(err))); }catch(_){ }
    try{
      if(UI.el.collectionPickList) UI.el.collectionPickList.innerHTML = "";
      if(UI.el.collectionPickEmpty) { UI.el.collectionPickEmpty.style.display = "block"; UI.el.collectionPickEmpty.textContent = "Could not load your movie list. " + (err && err.message ? ("Error: " + err.message) : ""); }
    }catch(_){ }
  }
}

  function syncCollectionArtUI(){
    const has = !!tempCollectionArtwork;
    UI.el.collectionArtPreview.style.display = has ? "block" : "none";
    UI.el.collectionArtPreview.src = tempCollectionArtwork || "";
    UI.el.collectionArtRemoveBtn.style.display = has ? "inline-flex" : "none";
  }

  async function fileToDataUrlScaled(file, max=420){
    const dataUrl = await new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(String(fr.result||""));
      fr.onerror = () => rej(new Error("read failed"));
      fr.readAsDataURL(file);
    });
    // scale via canvas (keeps storage sane)
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = () => rej(new Error("img load failed"));
      i.src = dataUrl;
    });
    const w = img.width || 0, h = img.height || 0;
    if(!w || !h) return dataUrl;
    const scale = Math.min(1, max / Math.max(w,h));
    if(scale >= 1) return dataUrl;
    const cw = Math.max(1, Math.round(w*scale));
    const ch = Math.max(1, Math.round(h*scale));
    const c = document.createElement("canvas");
    c.width = cw; c.height = ch;
    const ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0, cw, ch);
    return c.toDataURL("image/jpeg", 0.86);
  }



  // Sticky A–Z jump bar support
  let lastRendered = [];
  let activeAZ = null;
  let lastAzSig = "";
  let lastAzActive = "";
  let scrollSpyRaf = 0;

  function titleKeyNoArticles(t){
    const s = String(t || '').trim();
    // Ignore leading articles for navigation & sorting parity: The / A / An
    return s.replace(/^(the|a|an)\s+/i, '').trim();
  }

  function letterKeyFromTitle(t){
    const s = titleKeyNoArticles(t);
    const ch = (s[0] || '').toUpperCase();
    if(ch >= 'A' && ch <= 'Z') return ch;
    return '#';
  }

  function updateAZBar(){
    if(!UI.el.azBar) return;
    const enabled = new Set();
    for(const m of lastRendered){ enabled.add(letterKeyFromTitle(m.title)); }

    if(!activeAZ || !enabled.has(activeAZ)){
      activeAZ = lastRendered.length ? letterKeyFromTitle(lastRendered[0].title) : null;
    }

    const sig = Array.from(enabled).sort().join("");
    const act = activeAZ || "";
    if(sig === lastAzSig && act === lastAzActive) return;
    lastAzSig = sig; lastAzActive = act;

    UI.renderAZBar(enabled, activeAZ);
  }

  function pulseAZ(letter){
    if(!UI.el.azBar) return;
    const btn = UI.el.azBar.querySelector(`button[data-letter="${letter}"]`);
    if(!btn) return;
    btn.classList.remove("tapPulse");
    // force reflow so animation can replay
    void btn.offsetWidth;
    btn.classList.add("tapPulse");
    window.setTimeout(() => btn.classList.remove("tapPulse"), 260);
  }

  function updateActiveFromScroll(){
    scrollSpyRaf = 0;
    if(!UI.el.azBar || !UI.el.list) return;
    const items = UI.el.list.querySelectorAll(".item");
    if(!items.length) return;

    const barRect = UI.el.azBar.getBoundingClientRect();
    const topLine = barRect.bottom + 8;

    let found = null;
    for(let i=0;i<items.length;i++){
      const r = items[i].getBoundingClientRect();
      if(r.bottom > topLine){
        found = items[i];
        break;
      }
    }
    if(!found) found = items[items.length-1];

    const id = found.dataset.id;
    const m = lastRendered.find(x => String(x.id) === String(id));
    if(!m) return;

    const L = letterKeyFromTitle(m.title);
    if(L && L !== activeAZ){
      activeAZ = L;
      updateAZBar();
    }
  }

  function scheduleScrollSpy(){
    if(scrollSpyRaf) return;
    scrollSpyRaf = requestAnimationFrame(updateActiveFromScroll);
  }

  function jumpToLetter(letter){
    const L = String(letter || '').toUpperCase();
    if(!L) return;
    const m = lastRendered.find(x => letterKeyFromTitle(x.title) === L);
    if(!m) return;

    const target = UI.el.list.querySelector(`.item[data-id="${m.id}"]`);
    if(!target) return;

    activeAZ = L;
    updateAZBar();
    pulseAZ(L);

    const barH = UI.el.azBar ? UI.el.azBar.getBoundingClientRect().height : 0;
    const rect = target.getBoundingClientRect();
    const top = rect.top + window.scrollY - (barH + 16);
    window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
  }

  let apiKeys = Api.loadKeys();
  
    // Version stamp
    state.appVersion = APP_VERSION;
    if(UI.setVersion) UI.setVersion(APP_VERSION);
let editingId = null;
  let modalId = null;
  let currentPoster = "";
  let currentFullCast = "";

  let lastDeleted = null;
  let undoTimer = null;

  function clearUndo(){
    lastDeleted = null;
    if(undoTimer){ clearTimeout(undoTimer); undoTimer = null; }
  }

  function offerUndo(deletedMovie, index){
    clearUndo();
    lastDeleted = { movie: deletedMovie, index: index };
    UI.toastAction('Deleted.', 'Undo', () => {
      if(!lastDeleted) return;
      const pos = Math.max(0, Math.min(state.movies.length, lastDeleted.index));
      state.movies.splice(pos, 0, lastDeleted.movie);
      if(lastDeleted.movie && lastDeleted.movie.collectionId) addToCustomOrder(lastDeleted.movie.collectionId, lastDeleted.movie.id);
      state.appVersion = APP_VERSION;
      Store.save(state);
      clearUndo();
      render();
      UI.toast('Restored.');
    }, 5000);
    undoTimer = setTimeout(() => { clearUndo(); }, 5000);
  }

  function deleteMovieById(id){
    const idx = state.movies.findIndex(x => x.id === id);
    if(idx < 0) return { deleted:null, index:-1 };
    const deleted = state.movies[idx];
    if(deleted && deleted.collectionId) removeFromCustomOrder(deleted.collectionId, deleted.id);
    state.movies.splice(idx, 1);
    state.appVersion = APP_VERSION;
    Store.save(state);
    return { deleted, index: idx };
  }

  function getMovie(id){ return state.movies.find(x => x.id === id) || null; }

  function setPoster(dataUrl){
    currentPoster = dataUrl || "";
    UI.setPosterPreview(currentPoster);
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ""));
      r.onerror = () => reject(new Error("Could not read image."));
      r.readAsDataURL(file);
    });
  }

  function loadImage(src){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("Could not load image."));
      img.src = src;
    });
  }

  async function shrinkImage(file){
    // Convert to JPEG and downscale to keep LocalStorage small.
    const dataUrl = await readFileAsDataURL(file);
    const img = await loadImage(dataUrl);

    const maxW = 420;
    const maxH = 630;

    const w = img.naturalWidth || img.width || 1;
    const h = img.naturalHeight || img.height || 1;

    const scale = Math.min(1, maxW / w, maxH / h);
    const nw = Math.max(1, Math.round(w * scale));
    const nh = Math.max(1, Math.round(h * scale));

    const canvas = document.createElement("canvas");
    canvas.width = nw;
    canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);

    return canvas.toDataURL("image/jpeg", 0.82);
  }

  function getFilteredSorted(){
    const q = UI.el.q.value.trim().toLowerCase();
    const sort = UI.el.sort.value;
    let arr = [...state.movies];

    if(q){
      arr = arr.filter(m =>
        (m.title||"").toLowerCase().includes(q) ||
        (m.director||"").toLowerCase().includes(q) ||
        (m.cast||"").toLowerCase().includes(q) ||
        (m.release||"").toLowerCase().includes(q) ||
        (m.plot||"").toLowerCase().includes(q)
      );
    }

    const titleSortKey = (t) => {
      const s = String(t || '').trim();
      // Ignore leading articles for sorting only: The / A / An
      return s.replace(/^(the|a|an)\s+/i, '').trim();
    };

    const byTitle = (a,b) => titleSortKey(a.title).localeCompare(titleSortKey(b.title), undefined, { sensitivity:"base" });
    const byRelease = (a,b) => (a.release||"").localeCompare(b.release||"");
    const byAdded = (a,b) => (a.createdAt||0) - (b.createdAt||0);

    switch(sort){
      case "added_asc": arr.sort(byAdded); break;
      case "added_desc": arr.sort((a,b)=>byAdded(b,a)); break;
      case "title_desc": arr.sort((a,b)=>byTitle(b,a)); break;
      case "release_asc": arr.sort(byRelease); break;
      case "release_desc": arr.sort((a,b)=>byRelease(b,a)); break;
      default: arr.sort(byTitle);
    }
    return arr;
  }

  function persist(){ Store.save(state); }

  function render(){
    const arr = getFilteredSorted();
    lastRendered = arr;
    UI.renderList(arr);
    updateAZBar();
    scheduleScrollSpy();
    UI.setCount(arr.length);
    persist();
  }

  function resetForm(){
    editingId = null;
    setPoster("");
    currentFullCast = "";
    UI.clearForm();
    refreshCollectionSelectOptions("");
    UI.setEditMode(false);
    if(UI.el.saveBtn) UI.el.saveBtn.disabled = true;
  }

  function saveMovie(){
    const title = UI.el.title.value.trim();
    if(!title){
      UI.toast("Title is required.");
      UI.el.title.focus();
      return;
    }

    const existing = editingId ? getMovie(editingId) : null;
    const base = existing || Store.normalize({});
    const prevCollectionId = existing ? (existing.collectionId || "") : "";
    const nextCollectionId = (UI.el.collectionSelect ? String(UI.el.collectionSelect.value||"") : "");
    const movie = Store.normalize({
      ...base,
      id: editingId || base.id,
      title,
      release: UI.el.release.value.trim(),
      director: UI.el.director.value.trim(),
      collectionId: nextCollectionId,
      cast: (UI.el.cast ? UI.el.cast.value.trim() : ""),
      fullCast: (currentFullCast || (UI.el.cast ? UI.el.cast.value.trim() : "")),
      plot: (UI.el.plot ? UI.el.plot.value.trim() : ""),
      poster: currentPoster || "",
      updatedAt: Date.now(),
    });

    const idx = state.movies.findIndex(x => x.id === movie.id);
    if(idx >= 0){
      state.movies[idx] = movie;
      // update collection membership + ordering
      if(prevCollectionId !== nextCollectionId) setMovieCollection(movie.id, nextCollectionId, prevCollectionId);
      
      // After updating, reset back to Add mode (less confusion, matches your workflow)
      resetForm();
      render();
      UI.closeFormModal();
      UI.toast("Updated.");
    }else{
      state.movies.unshift(movie);
      if(nextCollectionId) setMovieCollection(movie.id, nextCollectionId, "");
      resetForm(); // auto-reset after adding
      render();
      UI.closeFormModal();
      UI.toast("Added.");
    }
  }

  function deleteMovie(){
    if(!editingId){ UI.toast('Nothing to delete.'); return; }
    const m = getMovie(editingId);
    if(!m){ UI.toast('Nothing to delete.'); return; }
    if(!confirm(`Delete "${m.title}"?`)) return;
    const out = deleteMovieById(m.id);
    resetForm();
    render();
    UI.closeFormModal();
    if(out.deleted) offerUndo(out.deleted, out.index);
  }

  function openModal(id){
    const m = getMovie(id);
    if(!m) return;
    modalId = id;
    UI.openModal(m);
  }

  function editFromModal(){
    if(!modalId) return;
    const m = getMovie(modalId);
    if(!m) return;
    editingId = m.id;
    UI.setEditMode(true);
    refreshCollectionSelectOptions(m.collectionId || "");
    UI.fillForm(m);
    setPoster(m.poster || "");
    currentFullCast = (m.fullCast || m.cast || "");
    UI.closeModal();
    UI.openFormModal();
    UI.el.title && UI.el.title.focus();
    if(UI.el.saveBtn) UI.el.saveBtn.disabled = !(UI.el.title && UI.el.title.value.trim());
    UI.toast("Loaded into editor.");
  }


  function openKeys(){
    apiKeys = Api.loadKeys();
    if(UI.el.tmdbKey) UI.el.tmdbKey.value = apiKeys.tmdb || "";
    UI.openKeysModal();
    UI.el.tmdbKey && UI.el.tmdbKey.focus();
  }

  function closeKeys(){ UI.closeKeysModal(); }

  async function fetchImageToDataUrl(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error("Could not fetch poster image.");
    const blob = await r.blob();
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result||""));
      fr.onerror = () => reject(new Error("Could not read poster image."));
      fr.readAsDataURL(blob);
    });
  }

  async function shrinkDataUrl(dataUrl){
    const img = await loadImage(dataUrl);
    const maxW = 420, maxH = 630;
    const w = img.naturalWidth || img.width || 1;
    const h = img.naturalHeight || img.height || 1;
    const scale = Math.min(1, maxW / w, maxH / h);
    const nw = Math.max(1, Math.round(w * scale));
    const nh = Math.max(1, Math.round(h * scale));
    const canvas = document.createElement("canvas");
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);
    return canvas.toDataURL("image/jpeg", 0.82);
  }

  async function autoFill(){
    const title = (UI.el.title && UI.el.title.value || "").trim();
    if(!title){
      UI.toast("Type a title first.");
      UI.el.title && UI.el.title.focus();
      return;
    }
    apiKeys = Api.loadKeys();
    if(!apiKeys.tmdb){
      UI.toast("Add your API keys first.");
      openKeys();
      return;
    }

    const year = ((UI.el.release && UI.el.release.value || "").trim().slice(0,4));
    const yearParam = (/^[0-9]{4}$/.test(year) ? year : "");

    UI.toast("Searching…");
    try{
      const s = await Api.tmdbSearch(title, yearParam, apiKeys.tmdb);
      const results = (s && s.results) ? s.results : [];
      if(!results.length) throw new Error("No TMDb match found.");

      // If multiple plausible matches, show picker
      const choice = bestMatch(results, title, yearParam);
      const many = results.length > 1;
      // If user gave no year and there are multiple results, prefer picker.
      if(many && !yearParam){
        renderPickList(results);
        return;
      }
      // If year provided but still multiple, fill best match.
      await performFill(choice.id, title);
    }catch(err){
      UI.toast(String(err.message || err));
    }
  }



  let pendingPick = null;

  function closePick(){
    pendingPick = null;
    UI.closePickModal();
  }

  function renderPickList(results){
    if(!UI.el.pickList) return;
    UI.el.pickList.innerHTML = "";
    const top = results.slice(0, 8);
    top.forEach(r => {
      const y = (r.release_date || "").slice(0,4);
      const title = r.title || r.original_title || "Untitled";
      const poster = Api.tmdbPosterUrl(r.poster_path);
      const item = document.createElement("div");
      item.className = "pickItem";
      item.innerHTML = `
        <div class="pickPoster">${poster ? `<img src="${poster}" alt="">` : "No<br>poster"}</div>
        <div class="pickMeta">
          <div class="pickTitle">${escapeHtml(title)}${y ? ` (${escapeHtml(y)})` : ""}</div>
          <div class="pickSub">${escapeHtml(r.original_language ? r.original_language.toUpperCase() : "")}</div>
        </div>
      `;
      item.addEventListener("click", async () => {
        try{
          UI.toast("Filling…");
          await performFill(r.id, title);
          closePick();
        }catch(e){
          UI.toast(String(e.message || e));
        }
      });
      UI.el.pickList.appendChild(item);
    });
    UI.openPickModal();
  }

  function bestMatch(results, title, year){
    if(!results || !results.length) return null;
    const t = title.toLowerCase().trim();
    const y = year && /^[0-9]{4}$/.test(year) ? year : "";
    // 1) exact title + year
    if(y){
      const exactYear = results.filter(r => (r.release_date||"").slice(0,4) === y);
      const exactTitleYear = exactYear.find(r => String(r.title||"").toLowerCase().trim() === t);
      if(exactTitleYear) return exactTitleYear;
      if(exactYear.length === 1) return exactYear[0];
    }
    // 2) exact title
    const exactTitle = results.find(r => String(r.title||"").toLowerCase().trim() === t);
    if(exactTitle) return exactTitle;
    // 3) best popularity
    return results[0];
  }

  async function performFill(tmdbId, typedTitle){
    apiKeys = Api.loadKeys();

    const d = await Api.tmdbDetails(tmdbId, apiKeys.tmdb);

    // credits for director(s) + top cast (TMDb)
    let directorFromTmdb = "";
    let tmdbCredits = null;
    try{
      tmdbCredits = await Api.tmdbCredits(tmdbId, apiKeys.tmdb);
const crew = (tmdbCredits && tmdbCredits.crew) ? tmdbCredits.crew : [];
      const dirs = crew
        .filter(x => x && x.job === "Director" && x.name)
        .map(x => String(x.name).trim())
        .filter(Boolean);
      const uniq = Array.from(new Set(dirs));
      directorFromTmdb = uniq.join(", ");
    }catch(_){}

    // Fill fields from TMDb (no OMDb)
    if(UI.el.title) UI.el.title.value = d.title || typedTitle || UI.el.title.value || "";
    if(UI.el.release) UI.el.release.value = d.release_date || UI.el.release.value || "";
    if(UI.el.director) UI.el.director.value = directorFromTmdb || UI.el.director.value || "";
    if(UI.el.cast) UI.el.cast.value = getTopCastFromCredits(tmdbCredits, 3) || UI.el.cast.value || "";
    currentFullCast = getFullCastFromCredits(tmdbCredits, 15) || UI.el.cast.value || "";

    if(UI.el.runtime && d.runtime != null) UI.el.runtime.value = String(d.runtime);
    if(UI.el.genre && Array.isArray(d.genres)) UI.el.genre.value = d.genres.map(g => g && g.name).filter(Boolean).join(", ");
    if(UI.el.plot) UI.el.plot.value = d.overview || UI.el.plot.value || "";

    // Poster
    const posterUrl = d && d.poster_path ? Api.tmdbPosterUrl(d.poster_path) : "";
    if(posterUrl){
      try{
        const dataUrl = await fetchImageToDataUrl(posterUrl);
        const small = await shrinkDataUrl(dataUrl);
        setPoster(small);
      }catch(_){
        // If TMDb image CORS blocks dataURL conversion, fall back to using the direct URL.
        setPoster(posterUrl);
      }
    }
const hasTitle = !!(UI.el.title && UI.el.title.value.trim());
    if(UI.el.saveBtn) UI.el.saveBtn.disabled = !hasTitle;

    UI.toast("Filled (TMDb).");
  }


  function wire(){
    let closeToolsMenu = () => {};
    const syncSaveEnabled = () => {
      const hasTitle = !!(UI.el.title && UI.el.title.value.trim());
      if(UI.el.saveBtn) UI.el.saveBtn.disabled = !hasTitle;
    };
    // Add Movie opens the Add/Edit popup
    if(UI.el.addMovieBtn){
      UI.el.addMovieBtn.addEventListener("click", () => {
        resetForm();
        UI.openFormModal();
        UI.el.title && UI.el.title.focus();
        syncSaveEnabled();
      });
    }

    // Collections button
    if(UI.el.collectionsBtn){
      UI.el.collectionsBtn.addEventListener("click", () => {
        openCollections();
      });
    }

    if(UI.el.formCloseBtn){
      UI.el.formCloseBtn.addEventListener("click", () => UI.closeFormModal());
    }
    if(UI.el.formModal){
      UI.el.formModal.addEventListener("click", (e) => {
        if(e.target === UI.el.formModal) UI.closeFormModal();
      });
    }

    // Keys modal
    if(UI.el.keysCloseBtn) UI.el.keysCloseBtn.addEventListener("click", closeKeys);
    if(UI.el.keysModal) UI.el.keysModal.addEventListener("click", (e) => { if(e.target === UI.el.keysModal) closeKeys(); });
    if(UI.el.keysSheet) UI.el.keysSheet.addEventListener("click", (e) => e.stopPropagation());
    if(UI.el.keysSaveBtn) UI.el.keysSaveBtn.addEventListener("click", () => {
      const tmdb = (UI.el.tmdbKey && UI.el.tmdbKey.value || "").trim();
      const omdb = "";
      Api.saveKeys({ tmdb, omdb });
      apiKeys = Api.loadKeys();
      UI.toast("Keys saved.");
      closeKeys();
    });
    if(UI.el.keysClearBtn) UI.el.keysClearBtn.addEventListener("click", () => {
      if(!confirm("Clear saved API keys on this device?")) return;
      Api.clearKeys();
      apiKeys = Api.loadKeys();
      if(UI.el.tmdbKey) UI.el.tmdbKey.value = "";
      UI.toast("Keys cleared.");
    });

    UI.el.saveBtn.addEventListener("click", saveMovie);
    if(UI.el.autoFillBtn) UI.el.autoFillBtn.addEventListener("click", autoFill);

    // Collections modal wiring
    if(UI.el.collectionsCloseBtn) UI.el.collectionsCloseBtn.addEventListener("click", closeCollections);
    if(UI.el.collectionsModal) UI.el.collectionsModal.addEventListener("click", (e)=>{
      if(e.target === UI.el.collectionsModal) closeCollections();
    });
    if(UI.el.collectionsBackBtn) UI.el.collectionsBackBtn.addEventListener("click", () => {
      // Leaving detail view should always exit reorder mode
      if(collectionReorderMode){
        collectionReorderMode = false;
        dragMovieId = "";
        if(UI.el.collectionOrderBtn) UI.el.collectionOrderBtn.textContent = "Reorder";
        if(UI.el.collectionSort) UI.el.collectionSort.disabled = false;
        if(UI.el.collectionQ) UI.el.collectionQ.disabled = false;
      }
      if(collectionsView === "detail"){ collectionsView = "list"; currentCollectionId = ""; }
      else if(collectionsView === "edit" || collectionsView === "pick"){ collectionsView = "detail"; }
      else { collectionsView = "list"; currentCollectionId = ""; }
      showCollectionsView();
    });

    if(UI.el.newCollectionBtn) UI.el.newCollectionBtn.addEventListener("click", () => {
      currentCollectionId = "";
      collectionsView = "edit";
      showCollectionsView();
    });

    if(UI.el.collectionsGrid) UI.el.collectionsGrid.addEventListener("click", (e)=>{
      const card = e.target.closest(".collectionCard");
      if(!card) return;
      currentCollectionId = card.dataset.id;
      collectionsView = "detail";
      showCollectionsView();
    });

    if(UI.el.collectionEditBtn) if(UI.el.collectionOrderBtn) UI.el.collectionOrderBtn.addEventListener("click", () => {
      toggleCollectionReorder();
    });

    UI.el.collectionEditBtn.addEventListener("click", () => {
      collectionsView = "edit";
      showCollectionsView();
    });

    if(UI.el.collectionSaveBtn) UI.el.collectionSaveBtn.addEventListener("click", () => {
      try{
      const name = (UI.el.collectionNameInput.value||"").trim();
      if(!name){ UI.toast("Collection name is required."); UI.el.collectionNameInput.focus(); return; }

      if(currentCollectionId){
        const col = getCollection(currentCollectionId);
        if(!col){ UI.toast("Collection not found."); collectionsView="list"; showCollectionsView(); return; }
        col.name = name;
        col.artwork = tempCollectionArtwork || "";
        col.updatedAt = Date.now();
      }else{
        const id = uid();
        state.collections.push({
          id,
          name,
          artwork: tempCollectionArtwork || "",
          sortMode: "custom",
          customOrder: [],
          createdAt: Date.now(),
          updatedAt: Date.now(),
        });
        currentCollectionId = id;
      }

      Store.save(state);
      refreshCollectionSelectOptions(UI.el.collectionSelect.value);
      UI.toast("Collection saved.");
      collectionsView = "detail";
      showCollectionsView();
      render();
      }catch(err){
        UI.toast("Could not save collection: " + String(err && err.message ? err.message : err));
      }
    });

    if(UI.el.collectionDeleteBtn) UI.el.collectionDeleteBtn.addEventListener("click", () => {
      const col = getCollection(currentCollectionId);
      if(!col) { collectionsView = "list"; currentCollectionId = ""; showCollectionsView(); return; }
      const ok = confirm(`Delete collection “${col.name}”? Movies will NOT be deleted.`);
      if(!ok) return;

      // unfile movies
      for(const m of state.movies){
        if((m.collectionId||"") === col.id) m.collectionId = "";
      }
      // remove collection
      state.collections = state.collections.filter(c => c.id !== col.id);

      Store.save(state);
      refreshCollectionSelectOptions(UI.el.collectionSelect.value);
      UI.toast("Collection deleted.");
      collectionsView = "list";
      currentCollectionId = "";
      showCollectionsView();
      render();
    });

    if(UI.el.collectionArtBtn) UI.el.collectionArtBtn.addEventListener("click", () => UI.el.collectionArtFile && UI.el.collectionArtFile.click());
    if(UI.el.collectionArtRemoveBtn) UI.el.collectionArtRemoveBtn.addEventListener("click", () => { tempCollectionArtwork = ""; syncCollectionArtUI(); });
    if(UI.el.collectionArtFile) UI.el.collectionArtFile.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        tempCollectionArtwork = await fileToDataUrlScaled(f, 420);
        syncCollectionArtUI();
      }catch(_){ UI.toast("Could not read image."); }
      UI.el.collectionArtFile.value = "";
    });

    if(UI.el.collectionAddExistingBtn) UI.el.collectionAddExistingBtn.addEventListener("click", () => {
      collectionsView = "pick";
      showCollectionsView();
    });

    if(UI.el.collectionAddNewBtn) UI.el.collectionAddNewBtn.addEventListener("click", () => {
      const col = getCollection(currentCollectionId);
      if(!col) return;
      closeCollections();
      resetForm();
      refreshCollectionSelectOptions(col.id);
      if(UI.el.collectionSelect) UI.el.collectionSelect.value = col.id;
      UI.openFormModal();
      UI.el.title && UI.el.title.focus();
      syncSaveEnabled();
    });

    if(UI.el.collectionQ) UI.el.collectionQ.addEventListener("input", renderCollectionDetail);
    if(UI.el.collectionSort) UI.el.collectionSort.addEventListener("change", renderCollectionDetail);
    // Drag/drop ordering inside a collection (custom order)
    UI.el.collectionList.addEventListener("dragstart", (e) => {
      if(!collectionReorderMode) return;
      const item = e.target && e.target.closest ? e.target.closest(".item") : null;
      if(!item) return;
      dragMovieId = item.dataset.id || "";
      item.classList.add("dragging");
      try{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", dragMovieId);
      }catch(err){}
    });

    UI.el.collectionList.addEventListener("dragover", (e) => {
      if(!collectionReorderMode) return;
      e.preventDefault();
      const item = e.target && e.target.closest ? e.target.closest(".item") : null;
      if(!item) return;
      item.classList.add("dragOver");
      try{ e.dataTransfer.dropEffect = "move"; }catch(err){}
    });

    UI.el.collectionList.addEventListener("dragleave", (e) => {
      if(!collectionReorderMode) return;
      const item = e.target && e.target.closest ? e.target.closest(".item") : null;
      if(item) item.classList.remove("dragOver");
    });

    UI.el.collectionList.addEventListener("drop", (e) => {
      if(!collectionReorderMode) return;
      e.preventDefault();
      const col = getCollection(currentCollectionId);
      if(!col) return;

      const target = e.target && e.target.closest ? e.target.closest(".item") : null;
      const dragged = dragMovieId || "";
      if(!dragged) return;

      const ids = Array.from(UI.el.collectionList.querySelectorAll(".item")).map(n => String(n.dataset.id||"")).filter(Boolean);
      const from = ids.indexOf(dragged);
      if(from === -1) return;

      // Determine insertion point
      let to = ids.length - 1;
      if(target){
        const tid = String(target.dataset.id||"");
        const tIndex = ids.indexOf(tid);
        if(tIndex !== -1) to = tIndex;
      }

      // Move dragged id to new position (insert before 'to')
      ids.splice(from, 1);
      // If dragging downward past target, adjust index after removal
      if(from < to) to = Math.max(0, to - 1);
      ids.splice(to, 0, dragged);

      col.customOrder = ids;
      Store.save(state);
      renderCollectionDetail();
    });

    UI.el.collectionList.addEventListener("dragend", (e) => {
      if(!collectionReorderMode) return;
      const items = UI.el.collectionList.querySelectorAll(".item");
      items.forEach(it => it.classList.remove("dragging","dragOver"));
      dragMovieId = "";
    });

    if(UI.el.collectionPickQ) UI.el.collectionPickQ.addEventListener("input", renderCollectionPick);

    if(UI.el.collectionList) UI.el.collectionList.addEventListener("click", (e) => {
      if(collectionReorderMode) return;
      const card = e.target.closest(".item");
      if(!card) return;

      // Remove from collection button (keep modal open)
      const removeBtn = e.target.closest(".removeFromCollectionBtn");
      if(removeBtn){
        e.preventDefault();
        e.stopPropagation();
        try{
          const col = getCollection(currentCollectionId);
          const movieId = card.dataset.id;
          const prevColId = getMovie(movieId)?.collectionId || "";
          setMovieCollection(movieId, "", prevColId);
          Store.save(state);
          UI.toast(col ? ("Removed from " + col.name + ".") : "Removed from collection.");
          renderCollectionDetail();
        }catch(err){
          console.error(err);
          UI.toast("Could not remove: " + (err && err.message ? err.message : String(err)));
        }
        return;
      }

      closeCollections();
      openModal(card.dataset.id);
    });

    if(UI.el.deleteBtn) UI.el.deleteBtn.addEventListener("click", deleteMovie);

    // Tools dropdown (Backup / Restore)
    if(UI.el.toolsBtn && UI.el.toolsMenu){
      closeToolsMenu = () => {
        UI.el.toolsMenu.classList.remove("open");
        UI.el.toolsBtn.setAttribute("aria-expanded","false");
      };
      UI.el.toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const open = UI.el.toolsMenu.classList.toggle("open");
        UI.el.toolsBtn.setAttribute("aria-expanded", open ? "true" : "false");
      });
      document.addEventListener("click", () => closeToolsMenu());
      document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeToolsMenu(); });
      UI.el.toolsMenu.addEventListener("click", (e) => e.stopPropagation());
    }


    if(UI.el.posterBtn && UI.el.posterFile){
      UI.el.posterBtn.addEventListener("click", () => UI.el.posterFile.click());
    }
    if(UI.el.posterRemoveBtn){
      UI.el.posterRemoveBtn.addEventListener("click", () => setPoster(""));
    }
    if(UI.el.posterFile){
      UI.el.posterFile.addEventListener("change", async () => {
        const f = UI.el.posterFile.files && UI.el.posterFile.files[0];
        if(!f) return;
        try{
          const dataUrl = await shrinkImage(f);
          setPoster(dataUrl);
          UI.toast("Poster set.");
        }catch(err){
          UI.toast(String(err.message || err));
        }finally{
          UI.el.posterFile.value = "";
        }
      });
    }


    UI.el.q.addEventListener("input", render);
    UI.el.sort.addEventListener("change", render);

    if(UI.el.azBar){
      UI.el.azBar.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-letter]");
        if(!btn || btn.classList.contains("disabled")) return;
        jumpToLetter(btn.dataset.letter);
      });
    // Scroll spy: keep A–Z highlight in sync while scrolling
    window.addEventListener("scroll", scheduleScrollSpy, { passive: true });
    window.addEventListener("resize", scheduleScrollSpy);

    }

    UI.el.list.addEventListener("click", (e) => {
      if(collectionReorderMode) return;
      const card = e.target.closest(".item");
      if(!card) return;
      openModal(card.dataset.id);
    });

    UI.el.closeBtn.addEventListener("click", () => { modalId=null; UI.closeModal(); });
    UI.el.modal.addEventListener("click", (e) => {
      if(e.target === UI.el.modal){ modalId=null; UI.closeModal(); }
    });
    UI.el.sheet.addEventListener("click", (e) => e.stopPropagation());
    if(UI.el.formSheet) UI.el.formSheet.addEventListener("click", (e) => e.stopPropagation());
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(UI.el.modal.classList.contains("open")){ modalId=null; UI.closeModal(); }
        if(UI.el.formModal && UI.el.formModal.classList.contains("open")){ UI.closeFormModal(); }
        if(UI.el.keysModal && UI.el.keysModal.classList.contains("open")){ UI.closeKeysModal(); }
        if(UI.el.pickModal && UI.el.pickModal.classList.contains("open")){ UI.closePickModal(); }
      }
    });
    UI.el.editBtn.addEventListener("click", editFromModal);
UI.el.modalDeleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if(!modalId) return;
      const m = getMovie(modalId);
      if(!m) return;
      if(!confirm(`Delete "${m.title}"?`)) return;
      const out = deleteMovieById(m.id);
      modalId = null;
      UI.closeModal();
      resetForm();
      render();
      if(out.deleted) offerUndo(out.deleted, out.index);
    });
if(UI.el.backupBtnTop) UI.el.backupBtnTop.addEventListener("click", async () => {
      closeToolsMenu();
      // iOS/iPadOS: this opens the Share Sheet where you can "Save to Files" and pick a folder/name
      try{
        const file = Store.makeExportFile(state);
        if(navigator.share && (!navigator.canShare || navigator.canShare({ files:[file] }))){
          await navigator.share({ files:[file], title:"Movie Vault Export", text:"Movie Vault backup JSON" });
          UI.toast("Share sheet opened.");
        }else{
          // Fallback: normal download
          Store.downloadExport(state);
          UI.toast("Downloaded (share not supported).");
        }
      }catch(err){
        // User cancel is not really an error; keep it quiet-ish.
        UI.toast("Export canceled.");
      }
    });
    if(UI.el.restoreBtnTop) UI.el.restoreBtnTop.addEventListener("click", () => { closeToolsMenu(); UI.el.importFile.click(); });
    if(UI.el.keysBtnTop) UI.el.keysBtnTop.addEventListener("click", () => { closeToolsMenu(); openKeys(); });
    if(UI.el.importFile) UI.el.importFile.addEventListener("change", async () => {
      const f = UI.el.importFile.files && UI.el.importFile.files[0];
      if(!f) return;
      try{
        state = await Store.importJSON(f);
        resetForm();
        render();
        UI.toast("Imported.");
      }catch(err){
        UI.toast(String(err.message || err));
      }finally{
        UI.el.importFile.value = "";
      }
    });

    if(UI.el.title) UI.el.title.addEventListener("input", syncSaveEnabled);
    if(UI.el.cast) UI.el.cast.addEventListener("input", () => { currentFullCast = UI.el.cast.value.trim(); });
    for(const inp of [UI.el.title, UI.el.release, UI.el.director]){
      inp.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){ e.preventDefault(); saveMovie(); }
      });
    }
    resetForm();
    if(UI.el.sort) UI.el.sort.value = 'title_asc';
    refreshCollectionSelectOptions("");
    render();
    syncSaveEnabled();
  }

  return { init: wire };
})();

(function(){
  const start = () => { try{ App.init(); }catch(err){ alert("Movie Vault error: " + (err && err.message ? err.message : String(err))); } };
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", start);
  else start();
})();

  applyAppVersion();
</script>
</body>
</html>
