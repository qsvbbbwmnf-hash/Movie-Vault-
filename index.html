<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Vault (Plain)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d81b60;
      --danger:#ff4d4d;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --r:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 30px; }
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      padding:10px 10px 14px;
    }
    h1{ margin:0; font-size:18px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:12px; }
    .pill{
      padding:8px 12px; border-radius:999px;

    }
    .toolsMenu{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      display:none;
      min-width: 190px;
      padding:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(20,22,30,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      z-index: 2200;
    }
    .toolsMenu.open{ display:grid; gap:8px; }
    .toolsMenu .btn{
      width:100%;
      justify-content:flex-start;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
      align-items:start;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .hd{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd h2{ margin:0; font-size:14px; }
    .bd{ padding:14px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, textarea{
      width:100%;
      padding:12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus{
      border-color: rgba(216,27,96,.55);
      box-shadow: 0 0 0 3px rgba(216,27,96,.16);
    }

    textarea{
      min-height: 92px;
      resize: vertical;
      line-height: 1.35;
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .grow{ flex:1; }
    .btn{
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{ background: rgba(216,27,96,.85); border-color: rgba(216,27,96,.55); }
    .btn.ghost{ background: rgba(255,255,255,.05); }
    .btn.danger{ background: rgba(255,77,77,.14); border-color: rgba(255,77,77,.30); }
    .btn.small{ padding:9px 10px; font-size:12px; border-radius: 11px; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .list{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 620px){ .list{ grid-template-columns: 1fr; } }
    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:12px;
      cursor:pointer;
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:12px;
      align-items:start;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .item:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.22);
      transform: translateY(-1px);
    }
    .item:active{
      transform: translateY(0px) scale(.995);
    }
    .title{ font-weight:900; margin:0 0 4px; font-size:14px; letter-spacing:.2px; }
    .meta{ color:var(--muted); font-size:12px; line-height:1.25; }
    .meta b{ color:rgba(255,255,255,.82); font-weight:800; }

    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.78);
      padding:5px 8px;
      border-radius: 999px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
    }
    .chip .k{ color: rgba(255,255,255,.55); font-weight:700; margin-right:6px; }

    /* Posters */
    .item{
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:10px;
      align-items:start;
    }
    .thumb{
      width:56px; height:76px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      object-fit: cover;
    }
    .thumb.ph{
      display:grid; place-items:center;
      font-size:10px;
      color: rgba(255,255,255,.55);
      text-align:center;
      padding:6px;
      line-height:1.1;
    }
    .posterPreview{
      display:none;
      width:100%;
      max-width:240px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      object-fit:cover;
    }
    .modalPoster{
      width: min(220px, 40vw);
      aspect-ratio: 2 / 3;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      object-fit: cover;
    }
    @media (max-width: 520px){
      .item{ grid-template-columns: 48px 1fr; }
      .thumb{ width:48px; height:64px; }
      .modalPoster{ width: min(160px, 44vw); }
    }

    .toast{
      position:fixed; left:50%; bottom:16px; transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      display:none;
      z-index:2000;
      max-width: min(700px, 92vw);
      text-align:center;
      font-size:13px;
    }
    .toast.show{ display:block; }

    .file{ display:none; }

    /* iOS Safari/WebView: file inputs cannot be display:none if you want .click() to open picker */
    .fileOffscreen{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
      pointer-events:none;
    }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin:12px 0; }

    /* Simple modal */
    .modal{
      position:fixed; inset:0;
      display:none; place-items:center;
      background: rgba(0,0,0,.62);
      padding:16px;
      z-index:1000;
    }
    .modal.open{ display:grid; }
    .sheet{
      width:min(720px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(20,22,30,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheet .top{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .sheet .body{ padding:14px; }
    .kv{ display:grid; gap:8px; }
    .kv .row{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:13px;
    }

    .kv .row.plot{
      flex-direction: column;
      align-items: flex-start;
    }
    .kv .row.plot .v{
      text-align: left;
      width: 100%;
      font-weight: 700;
      white-space: pre-wrap;
      line-height: 1.35;
    }
    .k{ color:var(--muted); }
    .v{ font-weight:800; text-align:right; }

    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.9);
    }

    .vsep{
      width:1px;
      height:28px;
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      margin:0 2px;
    }

    /* Modal motion (subtle) */
    .modal{
      opacity:0;
      transition: opacity .16s ease;
    }
    .modal.open{ opacity:1; }
    .sheet{
      transform: translateY(10px) scale(.99);
      transition: transform .16s ease;
    }
    .modal.open .sheet{
      transform: translateY(0) scale(1);
    }
    @media (prefers-reduced-motion: reduce){
      .modal, .sheet{ transition:none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Movie Vault</h1>
        <div class="sub">Plain build — manual entry only (v1.8.3 UX polish)</div>
      </div>
      <div class="row" style="gap:10px; align-items:center;">
        <button class="btn small primary" id="addMovieBtn" type="button">Add Movie</button>
        <div class="vsep" aria-hidden="true"></div>
        <div class="toolsWrap" style="position:relative;">
          <button class="btn small ghost" id="toolsBtn" type="button" aria-haspopup="true" aria-expanded="false">Vault Backup ▾</button>
          <div class="toolsMenu" id="toolsMenu" role="menu" aria-label="Vault Backup">
            <button class="btn small ghost toolsItem" id="backupBtnTop" type="button" role="menuitem">Backup to Files…</button>
            <button class="btn small ghost toolsItem" id="restoreBtnTop" type="button" role="menuitem">Restore from Files…</button>
          </div>
          <input id="importFile" class="fileOffscreen" type="file" accept="application/json" />
        </div>
        <div class="pill" id="versionPill" style="opacity:.9;">v1.8.3</div>
        <div class="pill" id="countPill">0 movies</div>
      </div>
    </header>

    <div class="grid">
      <!-- List -->
      <section class="card">
        <div class="hd">
          <h2>Library</h2>
          <div class="row">
            <input id="q" placeholder="Search title/director…" style="max-width:260px;" />
            <select id="sort" class="btn small" style="padding:9px 10px;">
              <option value="added_desc">Newest</option>
              <option value="added_asc">Oldest</option>
              <option value="title_asc">Title A→Z</option>
              <option value="title_desc">Title Z→A</option>
              <option value="release_desc">Release ↓</option>
              <option value="release_asc">Release ↑</option>
            </select>
          </div>
        </div>
        <div class="bd">
          <div id="list" class="list"></div>
          <div id="empty" class="hint" style="display:none; padding:10px 2px;">
            Empty vault. Add your first movie on the left.
          </div>
        </div>
      </section>
    </div>
  </div>


  <!-- Add/Edit modal -->
  <div class="modal" id="formModal" role="dialog" aria-modal="true" aria-label="Add or edit movie">
    <div class="sheet" id="formSheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="formTitle">Add Movie</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;">Manual entry — posters optional</div>
        </div>
        <div class="row">
          <button class="btn small ghost" id="formCloseBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body stack">
        <div>
          <label for="title">Movie Title</label>
          <input id="title" placeholder="e.g., Jaws" autocomplete="off" />
        </div>

        <div class="row">
          <div class="grow">
            <label for="release">Release Date</label>
            <input id="release" placeholder="YYYY-MM-DD (or just year)" autocomplete="off" />
          </div>
        </div>

        <div>
          <label for="director">Director</label>
          <input id="director" placeholder="e.g., Steven Spielberg" autocomplete="off" />
        </div>

        

        <div>
          <label for="plot">Plot</label>
          <textarea id="plot" placeholder="Short plot synopsis…" autocomplete="off"></textarea>
        </div>
<div>
          <label>Poster (optional)</label>
          <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn small ghost" id="posterBtn" type="button">Choose Poster…</button>
            <button class="btn small danger" id="posterRemoveBtn" type="button" style="display:none;">Remove</button>
            <input id="posterFile" class="fileOffscreen" type="file" accept="image/*" />
            <div class="hint" style="flex:1; min-width:220px;">Tip: JPG/PNG. Stored inside your vault (offline). Large images are auto-shrunk.</div>
          </div>
          <div style="margin-top:10px;">
            <img id="posterPreview" class="posterPreview" alt="Poster preview" />
          </div>
        </div>

        <div class="row">
          <button class="btn primary grow" id="saveBtn" type="button">Save Movie</button>
          <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Delete</button>
        </div>
        <div class="hint">Tip: Backups always use the same filename. Saving to the same folder will prompt you to replace the old file.</div>
      </div>
    </div>
  </div>

  <!-- Details modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Movie details">
    <div class="sheet" id="sheet">
      <div class="top">
        <div style="min-width:0;">
          <div style="font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="mTitle">—</div>
          <div style="color:rgba(255,255,255,.68); font-size:12px;" id="mSub">—</div>
        </div>
        <div class="row">
          <button class="btn small danger" id="modalDeleteBtn" type="button">Delete</button>
          <button class="btn small ghost" id="editBtn" type="button">Edit</button>
          <button class="btn small ghost" id="closeBtn" type="button">Close</button>
        </div>
      </div>
      <div class="body">
        <div class="kv" id="mKv"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
const APP_VERSION = "1.8.3";
/* =========================================================
   Movie Vault (Plain)
   Clean layers: Config • Store • UI • App
   Manual entry only (no OMDb/TMDb)
   ========================================================= */

/* 1) Config */
const Config = (() => {
  const VERSION = "1.8.3";
  const STORAGE_KEY = "movie_vault_plain_v1"; // fresh start
  return { VERSION, STORAGE_KEY };
})();

/* 2) Store */
const Store = (() => {
  let mem = null;

  function canLocalStorage(){
    try{
      const k="__mv_plain_test__";
      localStorage.setItem(k,"1");
      localStorage.removeItem(k);
      return true;
    }catch(_){ return false; }
  }
  const ok = canLocalStorage();

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function normalize(m){
    const now = Date.now();
    return {
      id: (m && m.id) ? String(m.id) : uid(),
      title: (m && m.title) ? String(m.title).trim() : "",
      release: (m && m.release) ? String(m.release).trim() : "",
      director: (m && m.director) ? String(m.director).trim() : "",
      plot: (m && m.plot) ? String(m.plot).trim() : "",
      poster: (m && m.poster) ? String(m.poster) : "", // data URL (embedded)
      createdAt: (m && m.createdAt) ? Number(m.createdAt) : now,
      updatedAt: (m && m.updatedAt) ? Number(m.updatedAt) : now,
    };
  }

  function load(){
    try{
      const raw = ok ? localStorage.getItem(Config.STORAGE_KEY) : mem;
      if(!raw) return { movies: [] };
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.movies)) return { movies: [] };
      parsed.movies = parsed.movies.map(normalize);
      return parsed;
    }catch(_){
      return { movies: [] };
    }
  }

  function save(state){
    try{
      const raw = JSON.stringify(state);
      if(ok) localStorage.setItem(Config.STORAGE_KEY, raw);
      else mem = raw;
      return true;
    }catch(_){
      return false;
    }
  }

  function makeExportFile(state){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    // File helps iOS share sheet understand what it is
    return new File([blob], "MovieVaultBackup_v1.8.3.json", { type: "application/json" });
  }

  function downloadExport(state){
    const file = makeExportFile(state);
    const url = URL.createObjectURL(file);
    const a = document.createElement("a");
    a.href = url;
    a.download = file.name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importJSON(file){
    const text = await file.text();
    const parsed = JSON.parse(text);
    if(!parsed || !Array.isArray(parsed.movies)) throw new Error("Invalid file: expected { movies: [...] }");
    parsed.movies = parsed.movies.map(normalize);
    return parsed;
  }

  return { ok, normalize, load, save, makeExportFile, downloadExport, importJSON };
})();

/* 3) UI */
const UI = (() => {
  const el = {
    title: document.getElementById("title"),
    release: document.getElementById("release"),
    director: document.getElementById("director"),
    plot: document.getElementById("plot"),
    // posters
    posterBtn: document.getElementById("posterBtn"),
    posterRemoveBtn: document.getElementById("posterRemoveBtn"),
    posterFile: document.getElementById("posterFile"),
    posterPreview: document.getElementById("posterPreview"),
    saveBtn: document.getElementById("saveBtn"),
    deleteBtn: document.getElementById("deleteBtn"),
    importFile: document.getElementById("importFile"),
    formTitle: document.getElementById("formTitle"),
    q: document.getElementById("q"),
    sort: document.getElementById("sort"),
    list: document.getElementById("list"),
    empty: document.getElementById("empty"),
    versionPill: document.getElementById("versionPill"),
    countPill: document.getElementById("countPill"),
    // add/edit modal
    addMovieBtn: document.getElementById("addMovieBtn"),
    formModal: document.getElementById("formModal"),
    formSheet: document.getElementById("formSheet"),
    formCloseBtn: document.getElementById("formCloseBtn"),
    // tools
    toolsBtn: document.getElementById("toolsBtn"),
    toolsMenu: document.getElementById("toolsMenu"),
    backupBtnTop: document.getElementById("backupBtnTop"),
    restoreBtnTop: document.getElementById("restoreBtnTop"),
    toast: document.getElementById("toast"),
    // modal
    modal: document.getElementById("modal"),
    sheet: document.getElementById("sheet"),
    mTitle: document.getElementById("mTitle"),
    mSub: document.getElementById("mSub"),
    mKv: document.getElementById("mKv"),
    closeBtn: document.getElementById("closeBtn"),
    editBtn: document.getElementById("editBtn"),
    modalDeleteBtn: document.getElementById("modalDeleteBtn"),
  };

  let toastTimer = null;
  function toast(msg){
    el.toast.textContent = msg;
    el.toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.toast.classList.remove("show"), 2200);
  }

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function setCount(n){ el.countPill.textContent = (n===1) ? "1 movie" : `${n} movies`; }

  function setEditMode(on){
    el.formTitle.textContent = on ? "Edit Movie" : "Add Movie";
    el.saveBtn.textContent = on ? "Update Movie" : "Save Movie";
    el.deleteBtn.style.display = on ? "inline-flex" : "none";
  }

  function fillForm(m){
    el.title.value = m.title || "";
    el.release.value = m.release || "";
    el.director.value = m.director || "";
    if(el.plot) el.plot.value = m.plot || "";
  }
  function clearForm(){
    el.title.value = "";
    el.release.value = "";
    el.director.value = "";
    if(el.plot) el.plot.value = "";
    if(el.posterPreview){
      el.posterPreview.src = "";
      el.posterPreview.style.display = "none";
    }
    if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "none";
    if(el.posterFile) el.posterFile.value = "";
  }

  function setPosterPreview(dataUrl){
    if(dataUrl){
      if(el.posterPreview){
        el.posterPreview.src = dataUrl;
        el.posterPreview.style.display = "block";
      }
      if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "inline-flex";
    }else{
      if(el.posterPreview){
        el.posterPreview.src = "";
        el.posterPreview.style.display = "none";
      }
      if(el.posterRemoveBtn) el.posterRemoveBtn.style.display = "none";
      if(el.posterFile) el.posterFile.value = "";
    }
  }

  function renderList(movies){
    el.list.innerHTML = "";
    el.empty.style.display = movies.length ? "none" : "block";
    for(const m of movies){
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = m.id;
      const thumb = m.poster
        ? `<img class="thumb" alt="Poster" src="${esc(m.poster)}" />`
        : `<div class="thumb ph">NO<br/>POSTER</div>`;

      const year = (m.release || "").trim().slice(0,4);
      const yearSafe = (/^[0-9]{4}$/.test(year) ? year : "—");

      div.innerHTML = `
        ${thumb}
        <div>
          <div class="title">${esc(m.title || "(Untitled)")}</div>
          <div class="chipRow">
            <span class="chip"><span class="k">Year</span>${esc(yearSafe)}</span>
            <span class="chip"><span class="k">Director</span>${esc(m.director || "—")}</span>
          </div>
        </div>
      `;
      el.list.appendChild(div);
    }
  }

  function openFormModal(){ el.formModal.classList.add("open"); }
  function closeFormModal(){ el.formModal.classList.remove("open"); }

  function openModal(m){
    el.mTitle.textContent = m.title || "(Untitled)";
    el.mSub.textContent = m.release ? `Release: ${m.release}` : "—";
    const poster = m.poster
      ? `<img class="modalPoster" alt="Poster" src="${esc(m.poster)}" />`
      : `<div class="modalPoster" style="display:grid; place-items:center; color:rgba(255,255,255,.55); font-size:12px;">No poster</div>`;

    el.mKv.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-bottom:12px;">
        ${poster}
        <div style="flex:1; min-width:240px;" class="kv">
          <div class="row"><div class="k">Title</div><div class="v">${esc(m.title || "—")}</div></div>
          <div class="row"><div class="k">Release</div><div class="v">${esc(m.release || "—")}</div></div>
          <div class="row"><div class="k">Director</div><div class="v">${esc(m.director || "—")}</div></div>
          <div class="row plot"><div class="k">Plot</div><div class="v">${esc(m.plot || "—")}</div></div>
          
        </div>
      </div>
    `;
    el.modal.classList.add("open");
  }
  function closeModal(){ el.modal.classList.remove("open"); }


  function setVersion(v){
    if(el.versionPill) el.versionPill.textContent = v ? ("v" + v) : "";
  }

  return { el, toast, setVersion, setCount, setEditMode, fillForm, clearForm, setPosterPreview, renderList, openFormModal, closeFormModal, openModal, closeModal };
})();

/* 4) App */
const App = (() => {
  let state = Store.load();
  
    // Version stamp
    state.appVersion = APP_VERSION;
    if(UI.setVersion) UI.setVersion(APP_VERSION);
let editingId = null;
  let modalId = null;
  let currentPoster = "";

  function getMovie(id){ return state.movies.find(x => x.id === id) || null; }

  function setPoster(dataUrl){
    currentPoster = dataUrl || "";
    UI.setPosterPreview(currentPoster);
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ""));
      r.onerror = () => reject(new Error("Could not read image."));
      r.readAsDataURL(file);
    });
  }

  function loadImage(src){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("Could not load image."));
      img.src = src;
    });
  }

  async function shrinkImage(file){
    // Convert to JPEG and downscale to keep LocalStorage small.
    const dataUrl = await readFileAsDataURL(file);
    const img = await loadImage(dataUrl);

    const maxW = 420;
    const maxH = 630;

    const w = img.naturalWidth || img.width || 1;
    const h = img.naturalHeight || img.height || 1;

    const scale = Math.min(1, maxW / w, maxH / h);
    const nw = Math.max(1, Math.round(w * scale));
    const nh = Math.max(1, Math.round(h * scale));

    const canvas = document.createElement("canvas");
    canvas.width = nw;
    canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);

    return canvas.toDataURL("image/jpeg", 0.82);
  }

  function getFilteredSorted(){
    const q = UI.el.q.value.trim().toLowerCase();
    const sort = UI.el.sort.value;
    let arr = [...state.movies];

    if(q){
      arr = arr.filter(m =>
        (m.title||"").toLowerCase().includes(q) ||
        (m.director||"").toLowerCase().includes(q) ||
        (m.release||"").toLowerCase().includes(q) ||
        (m.plot||"").toLowerCase().includes(q)
      );
    }

    const byTitle = (a,b) => (a.title||"").localeCompare(b.title||"", undefined, { sensitivity:"base" });
    const byRelease = (a,b) => (a.release||"").localeCompare(b.release||"");
    const byAdded = (a,b) => (a.createdAt||0) - (b.createdAt||0);

    switch(sort){
      case "added_asc": arr.sort(byAdded); break;
      case "added_desc": arr.sort((a,b)=>byAdded(b,a)); break;
      case "title_desc": arr.sort((a,b)=>byTitle(b,a)); break;
      case "release_asc": arr.sort(byRelease); break;
      case "release_desc": arr.sort((a,b)=>byRelease(b,a)); break;
      default: arr.sort(byTitle);
    }
    return arr;
  }

  function persist(){ Store.save(state); }

  function render(){
    const arr = getFilteredSorted();
    UI.renderList(arr);
    UI.setCount(arr.length);
    persist();
  }

  function resetForm(){
    editingId = null;
    setPoster("");
    UI.clearForm();
    UI.setEditMode(false);
    if(UI.el.saveBtn) UI.el.saveBtn.disabled = true;
  }

  function saveMovie(){
    const title = UI.el.title.value.trim();
    if(!title){
      UI.toast("Title is required.");
      UI.el.title.focus();
      return;
    }

    const existing = editingId ? getMovie(editingId) : null;
    const base = existing || Store.normalize({});
    const movie = Store.normalize({
      ...base,
      id: editingId || base.id,
      title,
      release: UI.el.release.value.trim(),
      director: UI.el.director.value.trim(),
      plot: (UI.el.plot ? UI.el.plot.value.trim() : ""),
      poster: currentPoster || "",
      updatedAt: Date.now(),
    });

    const idx = state.movies.findIndex(x => x.id === movie.id);
    if(idx >= 0){
      state.movies[idx] = movie;
      // After updating, reset back to Add mode (less confusion, matches your workflow)
      resetForm();
      render();
      UI.closeFormModal();
      UI.toast("Updated.");
    }else{
      state.movies.unshift(movie);
      resetForm(); // auto-reset after adding
      render();
      UI.closeFormModal();
      UI.toast("Added.");
    }
  }

  function deleteMovie(){
    if(!editingId){ UI.toast("Nothing to delete."); return; }
    const m = getMovie(editingId);
    if(!m){ UI.toast("Nothing to delete."); return; }
    if(!confirm(`Delete "${m.title}"?`)) return;
    state.movies = state.movies.filter(x => x.id !== m.id);
    resetForm();
    render();
    UI.closeFormModal();
    UI.toast("Deleted.");
  }

  function openModal(id){
    const m = getMovie(id);
    if(!m) return;
    modalId = id;
    UI.openModal(m);
  }

  function editFromModal(){
    if(!modalId) return;
    const m = getMovie(modalId);
    if(!m) return;
    editingId = m.id;
    UI.setEditMode(true);
    UI.fillForm(m);
    setPoster(m.poster || "");
    UI.closeModal();
    UI.openFormModal();
    UI.el.title && UI.el.title.focus();
    if(UI.el.saveBtn) UI.el.saveBtn.disabled = !(UI.el.title && UI.el.title.value.trim());
    UI.toast("Loaded into editor.");
  }

  function wire(){
    let closeToolsMenu = () => {};
    const syncSaveEnabled = () => {
      const hasTitle = !!(UI.el.title && UI.el.title.value.trim());
      if(UI.el.saveBtn) UI.el.saveBtn.disabled = !hasTitle;
    };
    // Add Movie opens the Add/Edit popup
    if(UI.el.addMovieBtn){
      UI.el.addMovieBtn.addEventListener("click", () => {
        resetForm();
        UI.openFormModal();
        UI.el.title && UI.el.title.focus();
        syncSaveEnabled();
      });
    }
    if(UI.el.formCloseBtn){
      UI.el.formCloseBtn.addEventListener("click", () => UI.closeFormModal());
    }
    if(UI.el.formModal){
      UI.el.formModal.addEventListener("click", (e) => {
        if(e.target === UI.el.formModal) UI.closeFormModal();
      });
    }

    UI.el.saveBtn.addEventListener("click", saveMovie);
UI.el.deleteBtn.addEventListener("click", deleteMovie);

    // Tools dropdown (Backup / Restore)
    if(UI.el.toolsBtn && UI.el.toolsMenu){
      closeToolsMenu = () => {
        UI.el.toolsMenu.classList.remove("open");
        UI.el.toolsBtn.setAttribute("aria-expanded","false");
      };
      UI.el.toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const open = UI.el.toolsMenu.classList.toggle("open");
        UI.el.toolsBtn.setAttribute("aria-expanded", open ? "true" : "false");
      });
      document.addEventListener("click", () => closeToolsMenu());
      document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeToolsMenu(); });
      UI.el.toolsMenu.addEventListener("click", (e) => e.stopPropagation());
    }


    if(UI.el.posterBtn && UI.el.posterFile){
      UI.el.posterBtn.addEventListener("click", () => UI.el.posterFile.click());
    }
    if(UI.el.posterRemoveBtn){
      UI.el.posterRemoveBtn.addEventListener("click", () => setPoster(""));
    }
    if(UI.el.posterFile){
      UI.el.posterFile.addEventListener("change", async () => {
        const f = UI.el.posterFile.files && UI.el.posterFile.files[0];
        if(!f) return;
        try{
          const dataUrl = await shrinkImage(f);
          setPoster(dataUrl);
          UI.toast("Poster set.");
        }catch(err){
          UI.toast(String(err.message || err));
        }finally{
          UI.el.posterFile.value = "";
        }
      });
    }


    UI.el.q.addEventListener("input", render);
    UI.el.sort.addEventListener("change", render);

    UI.el.list.addEventListener("click", (e) => {
      const card = e.target.closest(".item");
      if(!card) return;
      openModal(card.dataset.id);
    });

    UI.el.closeBtn.addEventListener("click", () => { modalId=null; UI.closeModal(); });
    UI.el.modal.addEventListener("click", (e) => {
      if(e.target === UI.el.modal){ modalId=null; UI.closeModal(); }
    });
    UI.el.sheet.addEventListener("click", (e) => e.stopPropagation());
    if(UI.el.formSheet) UI.el.formSheet.addEventListener("click", (e) => e.stopPropagation());
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(UI.el.modal.classList.contains("open")){ modalId=null; UI.closeModal(); }
        if(UI.el.formModal && UI.el.formModal.classList.contains("open")){ UI.closeFormModal(); }
      }
    });
    UI.el.editBtn.addEventListener("click", editFromModal);
UI.el.modalDeleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if(!modalId) return;
      const m = getMovie(modalId);
      if(!m) return;
      if(!confirm(`Delete "${m.title}"?`)) return;
      state.movies = state.movies.filter(x => x.id !== m.id);
      state.appVersion = APP_VERSION;
      Store.save(state);
      modalId = null;
      UI.closeModal();
      resetForm();
      render();
      UI.toast("Deleted.");
    });
if(UI.el.backupBtnTop) UI.el.backupBtnTop.addEventListener("click", async () => {
      closeToolsMenu();
      // iOS/iPadOS: this opens the Share Sheet where you can "Save to Files" and pick a folder/name
      try{
        const file = Store.makeExportFile(state);
        if(navigator.share && (!navigator.canShare || navigator.canShare({ files:[file] }))){
          await navigator.share({ files:[file], title:"Movie Vault Export", text:"Movie Vault backup JSON" });
          UI.toast("Share sheet opened.");
        }else{
          // Fallback: normal download
          Store.downloadExport(state);
          UI.toast("Downloaded (share not supported).");
        }
      }catch(err){
        // User cancel is not really an error; keep it quiet-ish.
        UI.toast("Export canceled.");
      }
    });
    if(UI.el.restoreBtnTop) UI.el.restoreBtnTop.addEventListener("click", () => { closeToolsMenu(); UI.el.importFile.click(); });
    if(UI.el.importFile) UI.el.importFile.addEventListener("change", async () => {
      const f = UI.el.importFile.files && UI.el.importFile.files[0];
      if(!f) return;
      try{
        state = await Store.importJSON(f);
        resetForm();
        render();
        UI.toast("Imported.");
      }catch(err){
        UI.toast(String(err.message || err));
      }finally{
        UI.el.importFile.value = "";
      }
    });

    if(UI.el.title) UI.el.title.addEventListener("input", syncSaveEnabled);
    for(const inp of [UI.el.title, UI.el.release, UI.el.director]){
      inp.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){ e.preventDefault(); saveMovie(); }
      });
    }

    resetForm();
    render();
    syncSaveEnabled();
  }

  return { init: wire };
})();

(function(){
  const start = () => { try{ App.init(); }catch(err){ alert("Movie Vault error: " + (err && err.message ? err.message : String(err))); } };
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", start);
  else start();
})();
</script>
</body>
</html>
